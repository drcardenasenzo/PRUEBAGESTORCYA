<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Cárdenas y Asociados | Gestión de Clientes y Pagos</title>
    <!-- Incluir Tailwind CSS desde CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Logo como Favicon -->
    <link rel="icon" href="logo.jpg">

    <style>
        /* Fuentes y Estilos Base de Cárdenas y Asociados */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --primary-color: #1E3A8A; /* Azul Oscuro */
            --secondary-color: #D4AF37; /* Dorado/Amarillo */
            --background-color: #f0f4f8;
            --text-color: #4B5E6A;
            --nora-color: #F472B6; /* Color distintivo para Nora */
            --enzo-color: #60A5FA; /* Color distintivo para Enzo */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            overflow-x: hidden; /* Previene scroll horizontal durante transiciones */
        }

        /* Estilo para las tarjetas principales */
        .card {
            background-color: #FFFFFF;
            border: 1px solid #dcdfe3;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            transition: all 0.3s ease-in-out;
        }

        /* Estilo para botones de acción */
        .action-btn {
            background-color: var(--primary-color);
            color: #FFFFFF;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: all 0.3s ease-in-out;
        }

        .action-btn:hover {
            background-color: #152E6A; /* Azul más oscuro */
            box-shadow: 0 4px 10px rgba(30, 58, 138, 0.3);
            transform: translateY(-1px);
        }
        
        /* Botón de Peligro (Eliminar) */
        .danger-btn {
            background-color: #DC2626; /* Rojo */
            color: #FFFFFF;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: all 0.3s ease-in-out;
        }
        .danger-btn:hover {
            background-color: #B91C1C; /* Rojo oscuro */
        }


        /* Estilo para botones secundarios (Dorado) */
        .secondary-btn {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            font-weight: 600;
            border-radius: 0.5rem;
            transition: all 0.3s ease-in-out;
        }

        .secondary-btn:hover {
            background-color: #C29D32; /* Dorado más oscuro */
            box-shadow: 0 4px 10px rgba(212, 175, 55, 0.3);
            transform: translateY(-1px);
        }

        /* Estilos para Paneles Full-Screen (Navegación) */
        .full-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: var(--background-color);
            z-index: 50;
            overflow-y: auto;
            display: none; /* Oculto por defecto */
            padding: 1rem;
        }

        .full-panel.active {
            display: block; /* Visible cuando está activo */
        }

        /* Estilo para modales de edición rápida */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 60;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem; /* Añadido padding para móviles */
        }

        .modal-content {
            background-color: #FFFFFF;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: translateY(1rem);
            opacity: 0;
            transition: all 0.3s ease-out;
            width: 100%; /* Ancho completo en móviles */
        }

        @media (min-width: 640px) { /* sm breakpoint */
            .modal-content {
                width: auto; /* Ancho automático en pantallas más grandes */
            }
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        
        /* Estilo para inputs enfocados */
        input:focus, select:focus, textarea:focus {
            border-color: var(--secondary-color) !important;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.4);
            outline: none;
        }

        /* Estilo para inputs deshabilitados (montos fijos) */
        input:disabled, input:read-only {
            background-color: #f3f4f6; /* gris claro */
            color: #6b7280; /* gris oscuro */
            cursor: not-allowed;
        }
        
        /* Tareas */
        .task-card-nora {
            border-left: 4px solid var(--nora-color);
        }
        .task-card-enzo {
            border-left: 4px solid var(--enzo-color);
        }

        /* Login Screen - Rediseñado */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: var(--background-color);
            z-index: 200;
            align-items: center;
            justify-content: center;
            display: flex; 
        }
        
        /* Clase auxiliar para ocultar login de forma forzada */
        #login-screen.hidden-force {
            display: none !important;
        }
        
        /* Animación sutil para el login */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .login-card-animation {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        
    </style>
</head>

<body class="p-2 sm:p-4 md:p-6 min-h-screen">

    <!-- PANTALLA DE LOGIN -->
    <div id="login-screen">
        <div class="login-card-animation bg-white p-8 rounded-2xl shadow-xl w-full max-w-md mx-4 border border-gray-200 relative overflow-hidden">
            <!-- Barra decorativa superior -->
            <div class="absolute top-0 left-0 w-full h-2 bg-[var(--primary-color)]"></div>
            
            <div class="text-center mb-8 mt-2">
                <!-- Logo reemplazado -->
                <div class="w-24 h-24 mx-auto mb-4 flex items-center justify-center">
                   <img src="logo.jpg" onerror="this.onerror=null;this.src='https://placehold.co/100x100/1E3A8A/D4AF37?text=GC'" alt="Logo" class="w-full h-full object-contain rounded-xl shadow-sm">
                </div>
                <h1 class="text-2xl sm:text-3xl font-bold flex justify-center items-baseline gap-2 flex-wrap">
                     <span class="text-[var(--primary-color)]">Gestor</span> 
                     <span class="text-[var(--secondary-color)] whitespace-nowrap">Cárdenas y Asociados</span>
                </h1>
            </div>

            <form id="login-form" class="space-y-6">
                <div class="space-y-1">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Usuario</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </span>
                        <input type="text" id="login-username" class="w-full pl-10 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--secondary-color)] outline-none transition-all bg-gray-50 focus:bg-white" placeholder="Ingrese usuario" required>
                    </div>
                </div>
                
                <div class="space-y-1">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Contraseña</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                        </span>
                        <input type="password" id="login-password" class="w-full pl-10 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--secondary-color)] outline-none transition-all bg-gray-50 focus:bg-white" required>
                    </div>
                </div>

                <button type="submit" class="w-full bg-[var(--primary-color)] text-white font-bold py-3 rounded-lg hover:bg-[#152E6A] transition-all shadow-md hover:shadow-lg transform active:scale-95 flex justify-center items-center gap-2">
                    <span>INGRESAR AL SISTEMA</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                    </svg>
                </button>
                
                <p id="login-error" class="text-red-600 text-sm text-center hidden font-medium bg-red-50 p-3 rounded-lg border border-red-100 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    <span>Usuario o contraseña incorrectos</span>
                </p>
            </form>
            
             <div class="mt-6 text-center border-t pt-4 border-gray-100">
                <p class="text-xs text-gray-400">© 2024 Cárdenas y Asociados. Acceso restringido.</p>
            </div>
        </div>
    </div>


    <!-- Mensaje de Carga y Errores (Toasts/Notificaciones) -->
    <div id="toast-container" class="fixed top-4 right-4 z-[100] space-y-2"></div>


    <!-- Contenedor Principal de la Aplicación -->
    <div id="app-container" class="mx-auto max-w-7xl hidden">
        <header class="bg-white p-4 shadow-lg rounded-xl mb-4 flex flex-col lg:flex-row justify-between items-center gap-4 lg:gap-0 z-40 relative">
            <!-- Header ajustado para móviles y PC: Flex-row, nowrap, items-center -->
            <div class="flex flex-row items-center gap-3 w-full lg:w-auto justify-center lg:justify-start whitespace-nowrap">
                <!-- Logo -->
                <img src="logo.jpg" onerror="this.onerror=null;this.src='https://placehold.co/50x50/1E3A8A/D4AF37?text=GC'" alt="Logo" class="h-10 w-10 sm:h-12 sm:w-12 object-contain rounded-lg flex-shrink-0">
                <!-- Texto Título en una sola línea -->
                <h1 class="text-base sm:text-lg md:text-2xl font-bold text-gray-700 flex items-baseline gap-1 sm:gap-2">
                    <span class="text-[var(--primary-color)]">Gestor</span> 
                    <span class="text-[var(--secondary-color)]">Cárdenas y Asociados</span>
                </h1>
            </div>

            <!-- Contenedor de Navegación -->
            <nav class="flex flex-row gap-2 w-full lg:w-auto justify-center lg:justify-end flex-nowrap items-center overflow-x-auto">
                <button onclick="navigate('dashboard')" class="text-xs sm:text-sm font-semibold p-2 rounded-lg transition-colors hover:bg-gray-100 flex-1 sm:flex-none text-center" id="nav-dashboard">Inicio</button>
                <button onclick="navigate('clients')" class="text-xs sm:text-sm font-semibold p-2 rounded-lg transition-colors hover:bg-gray-100 flex-1 sm:flex-none text-center" id="nav-clients">Clientes</button>
                <button onclick="navigate('payments')" class="text-xs sm:text-sm font-semibold p-2 rounded-lg transition-colors hover:bg-gray-100 flex-1 sm:flex-none text-center" id="nav-payments">Pagos</button>
                <button onclick="navigate('tasks')" class="text-xs sm:text-sm font-semibold p-2 rounded-lg transition-colors hover:bg-gray-100 flex-1 sm:flex-none text-center" id="nav-tasks">Tareas</button>
                
                <div class="h-6 w-px bg-gray-300 mx-1"></div>

                <button onclick="openUserManagementPanel()" class="text-xs sm:text-sm font-semibold p-2 rounded-lg transition-colors bg-blue-50 text-blue-600 hover:bg-blue-100 ml-1" title="Gestión de Usuarios">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                    </svg>
                </button>
                
                <button onclick="logout()" class="text-xs sm:text-sm font-semibold p-2 rounded-lg transition-colors bg-red-50 text-red-500 hover:bg-red-100 ml-1" title="Cerrar Sesión">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
            </nav>
        </header>

        <!-- Contenedor de Vistas Principales -->
        <main id="view-container" class="p-0 sm:p-4">
            <div id="dashboard" class="view-content hidden"></div>
            <div id="clients" class="view-content hidden"></div>
            <div id="payments" class="view-content hidden"></div>
            <div id="tasks" class="view-content hidden"></div>
        </main>
    </div>

    <!-- ======================================================= -->
    <!-- PANELES A PANTALLA COMPLETA (Full-Panels) -->
    <!-- ======================================================= -->
    
    <!-- Panel de Gestión de Usuarios -->
    <div id="user-management-panel" class="full-panel z-50">
        <div class="max-w-3xl mx-auto p-4 sm:p-6">
            <button onclick="closeFullPanel('user-management-panel')" class="px-4 py-2 mb-4 rounded-lg bg-gray-200 text-gray-700 font-semibold text-sm hover:bg-gray-300 transition-colors">
                Volver
            </button>
            <h2 class="text-3xl font-extrabold text-[var(--primary-color)] mb-2">Seguridad y Usuarios</h2>
            <p class="text-gray-500 mb-6">Gestione quién tiene acceso al sistema.</p>

            <!-- Formulario Nuevo Usuario -->
            <div class="card p-6 mb-6 bg-blue-50 border-blue-200">
                <h3 class="text-lg font-bold text-[var(--primary-color)] mb-4">Agregar Nuevo Usuario</h3>
                <form id="add-user-form" class="flex flex-col md:flex-row gap-4 items-end">
                    <div class="w-full">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre de Usuario</label>
                        <input type="text" id="new-user-name" placeholder="Ej: admin" class="w-full p-3 border border-gray-300 rounded-lg bg-white" required>
                    </div>
                    <div class="w-full">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Contraseña</label>
                        <input type="text" id="new-user-pass" placeholder="Contraseña" class="w-full p-3 border border-gray-300 rounded-lg bg-white" required>
                    </div>
                    <button type="submit" id="user-form-submit-btn" class="action-btn px-6 py-3 w-full md:w-auto whitespace-nowrap">
    Crear Usuario
</button>
                </form>
            </div>

            <!-- Lista de Usuarios -->
            <div class="card p-6">
                <h3 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">Usuarios Registrados</h3>
                <div id="users-list-container" class="space-y-2">
                    <!-- JS populated -->
                    <p class="text-gray-400 italic text-center">Cargando usuarios...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de Detalle de Cliente / Edición de Pagos -->
    <div id="client-detail-panel" class="full-panel z-50">
        <div class="max-w-4xl mx-auto p-4 sm:p-6">
            <!-- Botón "Volver" -->
            <button onclick="closeFullPanel('client-detail-panel')" class="px-4 py-2 mb-4 rounded-lg bg-gray-200 text-gray-700 font-semibold text-sm hover:bg-gray-300 transition-colors">
                Volver
            </button>
            <h2 id="client-detail-name" class="text-3xl font-extrabold text-[var(--primary-color)] mb-2 break-words"></h2>
            <p class="text-lg text-gray-600 mb-6 break-words">Expediente(s): <span id="client-detail-expedientes" class="font-medium text-gray-700"></span></p>

            <!-- Resumen de Pagos e Indicador -->
            <div class="card p-6 mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Indicador de Progreso -->
                <div class="col-span-1 md:col-span-1 flex flex-col items-center justify-center p-3 border-b md:border-b-0 md:border-r md:border-r-2 border-gray-200">
                    <div class="w-24 h-24 rounded-full border-4 border-gray-200 flex items-center justify-center" id="progress-ring-container">
                        <div id="progress-indicator" class="text-2xl font-bold text-[var(--primary-color)]">0%</div>
                    </div>
                    <p class="mt-2 text-sm font-semibold text-[var(--text-color)]">Progreso de Pago</p>
                </div>
                <!-- Plan de Pagos -->
                <div class="col-span-1 md:col-span-2">
                    <h3 class="text-xl font-semibold mb-3 flex justify-between items-center text-[var(--primary-color)]">
                        Plan de Pagos
                        <button onclick="openEditPaymentPlanModal()" class="text-sm px-3 py-1 bg-[var(--secondary-color)] text-[var(--primary-color)] rounded-full hover:bg-[#C29D32] transition-all duration-200">
                            Editar Plan
                        </button>
                    </h3>
                    <p class="text-lg mb-1">Convenio: <span id="plan-units" class="font-bold text-gray-800">0</span> <span id="plan-unit-type" class="font-semibold text-[var(--secondary-color)]">UMA/JUS</span>
                    <span id="plan-extra-fixed-display" class="hidden text-gray-600 text-sm"> + <span id="plan-extra-fixed-amount" class="font-bold"></span> ARS</span>
                    </p>
                    <p class="text-lg mb-1">Cuotas Totales: <span id="plan-total-quotas" class="font-bold text-gray-800">0</span></p>
                    <p class="text-lg mb-1">Porcentaje Socio: <span id="plan-partner-cut" class="font-bold text-gray-800">0</span>% <span id="plan-partner-name" class="text-sm text-gray-500"></span></p>
                    <p class="text-lg font-bold mt-2 border-t pt-2 border-gray-200">Valor Cuota (ARS): <span id="plan-quota-value-ars" class="text-red-600">$ 0.00</span></p>
                </div>
            </div>

            <!-- Lista de Cuotas -->
            <div class="card p-6 mb-8">
                <h3 class="text-xl font-semibold mb-4 text-[var(--primary-color)] border-b pb-2">Lista de Cuotas</h3>
                <div id="quotas-list" class="space-y-3">
                    <p class="text-center text-gray-500" id="no-quotas-message">Cargando cuotas...</p>
                </div>
            </div>

            <!-- Notas Adicionales -->
            <div class="card p-6 mb-8">
                <h3 class="text-xl font-semibold mb-4 text-[var(--primary-color)] border-b pb-2">Notas del Caso</h3>
                <textarea id="client-notes" rows="4" placeholder="Escribe notas adicionales sobre el cliente o el caso aquí..."
                    class="w-full p-3 border border-gray-300 rounded-lg transition-shadow focus:ring-4 focus:ring-[var(--secondary-color)]/50"></textarea>
                <button onclick="saveClientNotes()" class="action-btn px-4 py-2 mt-3 w-full sm:w-auto">Guardar Notas</button>
            </div>
        </div>
    </div>

    <!-- Panel de Agregar/Editar Cliente -->
    <div id="add-edit-client-panel" class="full-panel z-50">
        <div class="max-w-3xl mx-auto p-4 sm:p-6">
            <button onclick="closeFullPanel('add-edit-client-panel')" class="px-4 py-2 mb-4 rounded-lg bg-gray-200 text-gray-700 font-semibold text-sm hover:bg-gray-300 transition-colors">
                Atrás
            </button>
            <h2 id="add-edit-client-title" class="text-3xl font-extrabold text-[var(--primary-color)] mb-6">Agregar Nuevo Cliente</h2>
            <form id="client-form" class="space-y-4 card p-6">
                <!-- Datos Personales -->
                <h3 class="text-xl font-semibold text-[var(--secondary-color)] border-b pb-2 mb-4">Datos Personales</h3>
                <input type="hidden" id="client-id-field">
                <input type="text" id="client-full-name" placeholder="Nombre Completo" required class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <input type="text" id="client-dni" placeholder="DNI" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                    <input type="email" id="client-email" placeholder="Correo Electrónico" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                    <input type="tel" id="client-phone" placeholder="Celular" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                </div>

                <!-- Detalles del Caso -->
                <h3 class="text-xl font-semibold text-[var(--secondary-color)] border-b pb-2 pt-4 mb-4">Detalles del Caso</h3>
                <textarea id="client-case-facts" placeholder="Hechos del caso (Resumen)" rows="3" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow"></textarea>
                <input type="text" id="client-expedientes" placeholder="Expediente(s) (separados por coma, ej: Exp-123, Exp-456)" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">

                <!-- Plan de Pagos Inicial -->
                <h3 class="text-xl font-semibold text-[var(--secondary-color)] border-b pb-2 pt-4 mb-4">Plan de Pagos Inicial</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="sm:col-span-1">
                        <label class="block text-sm font-medium mb-1">Valor en Unidades</label>
                        <input type="text" id="plan-total-units" placeholder="Ej: 150 o 88,8" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                    </div>
                    <div class="sm:col-span-1">
                        <label class="block text-sm font-medium mb-1">Tipo Unidad</label>
                        <select id="plan-unit-type-select" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                            <option value="UMA">UMA</option>
                            <option value="JUS">JUS</option>
                        </select>
                    </div>
                    <div class="sm:col-span-1">
                        <label class="block text-sm font-medium mb-1">Monto Fijo Adicional (ARS)</label>
                        <input type="text" id="plan-fixed-amount" placeholder="$ 0" oninput="formatCurrencyInput(event)" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Cantidad de Cuotas</label>
                        <input type="number" id="plan-total-quotas-input" placeholder="Ej: 36" min="1" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                    </div>
                    <div>
                         <!-- Selector de Socio y Porcentaje -->
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-sm font-medium">Porcentaje Socio</label>
                            <button type="button" onclick="openEditPayeesModal()" class="text-xs text-[var(--primary-color)] hover:underline">Gestionar Socios</button>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="plan-partner-cut" placeholder="%" class="w-20 p-3 border border-gray-300 rounded-lg transition-shadow" oninput="this.value = this.value.replace(/[^0-9,]/g, '')">
                            <select id="plan-partner-select" class="flex-1 p-3 border border-gray-300 rounded-lg transition-shadow">
                                <option value="">-- Socio --</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-2">
                    <div>
                        <label class="block text-sm font-medium mb-1">Mes de Inicio del Plan</label>
                        <input type="month" id="plan-start-month" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Cuotas Pagadas Inicialmente</label>
                        <input type="number" id="plan-initial-paid-quotas" value="0" min="0" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                    </div>
                </div>

                <button type="submit" class="action-btn px-6 py-3 mt-6 w-full" id="client-form-submit-btn">Guardar Cliente</button>
            </form>
        </div>
    </div>

    <!-- Panel de Registro de Otros Ingresos -->
    <div id="add-other-income-panel" class="full-panel z-50">
        <div class="max-w-3xl mx-auto p-4 sm:p-6">
            <button onclick="closeFullPanel('add-other-income-panel')" class="px-4 py-2 mb-4 rounded-lg bg-gray-200 text-gray-700 font-semibold text-sm hover:bg-gray-300 transition-colors">
                Atrás
            </button>
            <h2 class="text-3xl font-extrabold text-[var(--primary-color)] mb-6">Registrar Otro Ingreso</h2>
            <form id="add-other-income-form" class="space-y-4 card p-6">
                <div>
                    <label class="block text-sm font-medium mb-1">Concepto</label>
                    <input type="text" id="income-custom-concept" placeholder="Especifique el concepto (Ej: Alquiler Local 2)" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow" required>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                     <div>
                        <label class="block text-sm font-medium mb-1">Teléfono (Optativo)</label>
                        <input type="tel" id="income-phone" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Email (Optativo)</label>
                        <input type="email" id="income-email" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                    </div>
                     <div>
                        <label class="block text-sm font-medium mb-1">Expediente (Optativo)</label>
                        <input type="text" id="income-expediente" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                    </div>
                </div>

                
                <h3 class="text-xl font-semibold text-[var(--secondary-color)] border-b pb-2 pt-4 mb-4">Detalles del Ingreso</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium mb-1">Valor Total (en unidades o ARS)</label>
                        <input type="text" id="income-total-units" placeholder="Ej: 150 o 150000 o 88,8" required class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Unidad de Medida</label>
                        <select id="income-unit-type-select" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                            <option value="ARS">ARS (Monto Fijo)</option>
                            <option value="UMA">UMA</option>
                            <option value="JUS">JUS</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Cantidad de Cuotas</label>
                        <input type="number" id="income-total-quotas-input" placeholder="Ej: 12" required min="1" value="1" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-sm font-medium">Porcentaje Socio</label>
                            <button type="button" onclick="openEditPayeesModal()" class="text-xs text-[var(--primary-color)] hover:underline">Gestionar</button>
                        </div>
                        <div class="flex gap-2">
                            <input type="number" id="income-partner-cut" placeholder="%" value="0" min="0" max="100" class="w-20 p-3 border border-gray-300 rounded-lg transition-shadow">
                            <select id="income-partner-select" class="flex-1 p-3 border border-gray-300 rounded-lg transition-shadow">
                                <option value="">-- Socio --</option>
                                <!-- Se llena dinámicamente -->
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-2">
                    <div>
                        <label class="block text-sm font-medium mb-1">Mes de Inicio del Plan</label>
                        <input type="month" id="income-start-month" required class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Cuotas Pagadas Inicialmente</label>
                        <input type="number" id="income-initial-paid-quotas" value="0" min="0" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                    </div>
                </div>

                <button type="submit" class="action-btn px-6 py-3 mt-6 w-full">Registrar Ingreso</button>
            </form>
        </div>
    </div>
    
    <!-- Panel de Detalle de Otros Ingresos -->
    <div id="other-income-detail-panel" class="full-panel z-50">
        <div class="max-w-4xl mx-auto p-4 sm:p-6">
            <button onclick="closeFullPanel('other-income-detail-panel')" class="px-4 py-2 mb-4 rounded-lg bg-gray-200 text-gray-700 font-semibold text-sm hover:bg-gray-300 transition-colors">
                Volver
            </button>
            <h2 id="other-income-detail-name" class="text-3xl font-extrabold text-[var(--primary-color)] mb-6 break-words"></h2>
            <div id="other-income-extra-info" class="mb-6 text-gray-600 grid grid-cols-1 sm:grid-cols-3 gap-2 text-sm"></div>

            <!-- Resumen de Pagos -->
            <div class="card p-6 mb-8">
                <h3 class="text-xl font-semibold mb-3 flex justify-between items-center text-[var(--primary-color)]">
                    Plan de Ingreso
                     <button onclick="openEditOtherIncomeModal()" class="text-sm px-3 py-1 bg-[var(--secondary-color)] text-[var(--primary-color)] rounded-full hover:bg-[#C29D32] transition-all duration-200">
                        Editar Plan
                    </button>
                </h3>
                <p class="text-lg mb-1">Unidades: <span id="other-income-plan-units" class="font-bold text-gray-800">0</span> <span id="other-income-plan-unit-type" class="font-semibold text-[var(--secondary-color)]"></span></p>
                <p class="text-lg mb-1">Cuotas Totales: <span id="other-income-plan-total-quotas" class="font-bold text-gray-800">0</span></p>
                <p class="text-lg mb-1">Porcentaje Socio: <span id="other-income-partner-cut" class="font-bold text-gray-800">0</span>% <span id="other-income-partner-name" class="text-sm text-gray-500"></span></p>
                <p class="text-lg font-bold mt-2 border-t pt-2 border-gray-200">Valor Cuota (ARS): <span id="other-income-plan-quota-value-ars" class="text-red-600">$ 0.00</span></p>
            </div>

            <!-- Lista de Cuotas -->
            <div class="card p-6 mb-8">
                <h3 class="text-xl font-semibold mb-4 text-[var(--primary-color)] border-b pb-2">Lista de Cuotas</h3>
                <div id="other-income-quotas-list" class="space-y-3">
                    <!-- Las cuotas de otros ingresos se renderizarán aquí -->
                </div>
            </div>
        </div>
    </div>


    <!-- ======================================================= -->
    <!-- MODALES DE EDICIÓN RÁPIDA (Modals) -->
    <!-- ======================================================= -->

    <!-- Modal de Edición de Valores UMA/JUS -->
    <div id="uma-jus-modal" class="modal-overlay">
        <div class="modal-content max-w-sm">
            <h3 class="text-xl font-bold text-[var(--primary-color)] mb-4">Editar Valores Base</h3>
            <p class="text-sm text-gray-500 mb-4">Estos valores se usan para calcular el monto en pesos de las cuotas.</p>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium mb-1">Valor UMA (ARS)</label>
                    <input type="text" id="uma-value-input" class="w-full p-3 border border-gray-300 rounded-lg" required oninput="formatCurrencyInput(event)" placeholder="$ 0">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Valor JUS (ARS)</label>
                    <input type="text" id="jus-value-input" class="w-full p-3 border border-gray-300 rounded-lg" required oninput="formatCurrencyInput(event)" placeholder="$ 0">
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeModal('uma-jus-modal')" class="px-4 py-2 text-[var(--text-color)] hover:bg-gray-100 rounded-lg transition-colors">Cancelar</button>
                <button onclick="saveUmaJusValues()" class="action-btn px-4 py-2">Guardar Valores</button>
            </div>
        </div>
    </div>

    <!-- Modal de Edición de Plan de Pagos (CLIENTES) -->
    <div id="edit-payment-plan-modal" class="modal-overlay">
        <div class="modal-content max-w-lg">
            <h3 class="text-xl font-bold text-[var(--primary-color)] mb-4">Editar Plan de Pagos (Cliente)</h3>
            <p class="text-sm text-gray-500 mb-4">Esta acción recalculará el valor de las cuotas futuras (No pagadas).</p>
            <form id="edit-payment-plan-form" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="sm:col-span-1">
                        <label class="block text-sm font-medium mb-1">Valor Unidades</label>
                        <input type="text" id="edit-plan-total-units" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                     <div class="sm:col-span-1">
                        <label class="block text-sm font-medium mb-1">Tipo</label>
                        <select id="edit-plan-unit-type-select" class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="UMA">UMA</option>
                            <option value="JUS">JUS</option>
                        </select>
                    </div>
                    <div class="sm:col-span-1">
                        <label class="block text-sm font-medium mb-1">Fijo Extra (ARS)</label>
                        <input type="text" id="edit-plan-fixed-amount" oninput="formatCurrencyInput(event)" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="$ 0">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Cantidad de Cuotas</label>
                        <input type="number" id="edit-plan-total-quotas-input" class="w-full p-3 border border-gray-300 rounded-lg" required min="1">
                    </div>
                    <div>
                        <!-- NUEVO: Selector de Socio y Porcentaje al editar -->
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-sm font-medium">Porcentaje Socio</label>
                            <button type="button" onclick="openEditPayeesModal()" class="text-xs text-[var(--primary-color)] hover:underline">Gestionar</button>
                        </div>
                        <div class="flex gap-2">
                             <input type="text" id="edit-plan-partner-cut" value="0" min="0" max="100" class="w-20 p-3 border border-gray-300 rounded-lg transition-shadow" oninput="this.value = this.value.replace(/[^0-9,]/g, '')">
                             <select id="edit-plan-partner-select" class="flex-1 p-3 border border-gray-300 rounded-lg transition-shadow">
                                <option value="">-- Socio --</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeModal('edit-payment-plan-modal')" class="px-4 py-2 text-[var(--text-color)] hover:bg-gray-100 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="action-btn px-4 py-2">Aplicar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Edición de Plan (OTROS INGRESOS) -->
    <div id="edit-other-income-modal" class="modal-overlay">
        <div class="modal-content max-w-lg">
            <h3 class="text-xl font-bold text-[var(--primary-color)] mb-4">Editar Otro Ingreso</h3>
            <p class="text-sm text-gray-500 mb-4">Recalculará cuotas futuras. Puede asignar socio aquí.</p>
            <form id="edit-other-income-form" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Valor Total</label>
                        <input type="text" id="edit-income-total-units" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                     <div>
                        <label class="block text-sm font-medium mb-1">Tipo Unidad</label>
                        <select id="edit-income-unit-type-select" class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="ARS">ARS (Fijo)</option>
                            <option value="UMA">UMA</option>
                            <option value="JUS">JUS</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Cantidad de Cuotas</label>
                        <input type="number" id="edit-income-total-quotas-input" class="w-full p-3 border border-gray-300 rounded-lg" required min="1">
                    </div>
                    <div>
                         <div class="flex justify-between items-center mb-1">
                            <label class="block text-sm font-medium">Porcentaje Socio</label>
                        </div>
                        <div class="flex gap-2">
                             <input type="text" id="edit-income-partner-cut" value="0" min="0" max="100" class="w-20 p-3 border border-gray-300 rounded-lg transition-shadow" oninput="this.value = this.value.replace(/[^0-9,]/g, '')">
                             <select id="edit-income-partner-select" class="flex-1 p-3 border border-gray-300 rounded-lg transition-shadow">
                                <option value="">-- Socio --</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeModal('edit-other-income-modal')" class="px-4 py-2 text-[var(--text-color)] hover:bg-gray-100 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="action-btn px-4 py-2">Aplicar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Registro/Edición de Egresos -->
    <div id="add-expense-modal" class="modal-overlay">
        <div class="modal-content max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 id="expense-modal-title" class="text-xl font-bold text-[var(--primary-color)]">Registrar Egreso</h3>
                <button onclick="openEditExpenseConceptsModal()" class="text-sm text-[var(--primary-color)] hover:text-[var(--secondary-color)] transition-colors">
                    Editar Conceptos
                </button>
            </div>
            
            <p class="text-sm text-gray-500 mb-4">Registre una salida de dinero (gasto). Quedará asentado con la fecha y hora actual.</p>
            <form id="add-expense-form" class="space-y-4">
                <input type="hidden" id="expense-id-field">
                
                <div>
                    <label class="block text-sm font-medium mb-1">Concepto</label>
                    <select id="expense-concept-select" onchange="handleExpenseConceptChange(this)" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                        <!-- Opciones se cargarán dinámicamente -->
                    </select>
                </div>
                <div id="custom-concept-wrapper" class="hidden">
                    <label class="block text-sm font-medium mb-1">Concepto (Otro)</label>
                    <input type="text" id="expense-custom-concept" placeholder="Especifique el concepto" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                </div>
                
                <!-- Nuevo Campo: Beneficiario (Pagar a) -->
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm font-medium">Pagar a (Beneficiario/Socio)</label>
                        <button type="button" onclick="openEditPayeesModal()" class="text-xs text-[var(--primary-color)] hover:underline">Gestionar</button>
                    </div>
                    <select id="expense-payee-select" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                        <option value="">-- Seleccionar Beneficiario --</option>
                        <!-- Opciones se cargarán dinámicamente -->
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Monto (ARS)</label>
                    <input type="text" id="expense-amount" placeholder="$ 0" required min="1" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow" oninput="formatCurrencyInput(event)">
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeModal('add-expense-modal')" class="px-4 py-2 text-[var(--text-color)] hover:bg-gray-100 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" id="expense-form-submit-btn" class="action-btn px-4 py-2">Registrar Egreso</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Edición de Conceptos de Egreso -->
    <div id="edit-expense-concepts-modal" class="modal-overlay z-[70]"> 
        <div class="modal-content max-w-md w-full">
            <h3 class="text-xl font-bold text-[var(--primary-color)] mb-4">Editar Conceptos de Egreso</h3>
            
            <p class="text-sm text-gray-500 mb-2">Configure los montos fijos. Un monto de 0 o vacío significa que será variable y se pedirá al registrar.</p>
            
            <div class="space-y-3 max-h-60 overflow-y-auto" id="expense-concepts-list-container">
                <!-- La lista de conceptos se renderizará aquí -->
            </div>
            
            <form id="add-expense-concept-form" class="mt-4 flex space-x-2">
                <input type="text" id="new-expense-concept-input" placeholder="Nuevo concepto" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                <button type="submit" class="action-btn px-4 py-2">Agregar</button>
            </form>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeModal('edit-expense-concepts-modal')" class="px-4 py-2 text-[var(--text-color)] hover:bg-gray-100 rounded-lg transition-colors">Cancelar</button>
                <button type="button" onclick="saveExpenseConceptAmounts()" class="action-btn px-4 py-2">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Gestión de Beneficiarios (NUEVO) -->
    <div id="edit-payees-modal" class="modal-overlay z-[75]"> 
        <div class="modal-content max-w-md w-full">
            <h3 class="text-xl font-bold text-[var(--primary-color)] mb-4">Gestionar Socios y Beneficiarios</h3>
            
            <p class="text-sm text-gray-500 mb-2">Personas a las que se les realizan pagos o asignan porcentajes.</p>
            
            <div class="space-y-3 max-h-60 overflow-y-auto" id="payees-list-container">
                <!-- La lista de beneficiarios se renderizará aquí -->
            </div>
            
            <form id="add-payee-form" class="mt-4 flex space-x-2">
                <input type="text" id="new-payee-input" placeholder="Nuevo nombre (ej: Sabrina)" class="w-full p-3 border border-gray-300 rounded-lg transition-shadow">
                <button type="submit" class="action-btn px-4 py-2">Agregar</button>
            </form>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeModal('edit-payees-modal')" class="px-4 py-2 text-[var(--text-color)] hover:bg-gray-100 rounded-lg transition-colors">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación Genérico -->
    <div id="confirm-modal" class="modal-overlay z-[80]"> 
        <div class="modal-content max-w-sm">
            <h3 id="confirm-modal-title" class="text-xl font-bold text-red-600 mb-4">Confirmar Acción</h3>
            <p id="confirm-modal-body" class="text-gray-600 mb-6">¿Estás seguro de que deseas continuar?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-modal-cancel" class="px-4 py-2 text-[var(--text-color)] hover:bg-gray-100 rounded-lg transition-colors">Cancelar</button>
                <button id="confirm-modal-confirm" class="danger-btn px-4 py-2">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE PERMISO DENEGADO -->
    <div id="permission-modal" class="modal-overlay z-[150]"> 
        <div class="modal-content max-w-sm text-center">
            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd" />
                </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Acceso Restringido</h3>
            <p class="text-gray-600 mb-6">No posee permiso para realizar esta acción.</p>
            <button onclick="document.getElementById('permission-modal').classList.remove('active')" class="bg-gray-200 text-gray-800 font-semibold px-6 py-2 rounded-lg hover:bg-gray-300 transition-colors">Entendido</button>
        </div>
    </div>

    <script type="module">
        // =================================================================================
        // FIREBASE SETUP AND GLOBAL VARIABLES
        // =================================================================================
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import {
    getFirestore, setLogLevel, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        // Configuración de Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyBvXXACPC7r_Ix-taS_P_ZJBxhyZAzrg-A",
          authDomain: "gestor-cya.firebaseapp.com",
          projectId: "gestor-cya",
          storageBucket: "gestor-cya.firebasestorage.app",
          messagingSenderId: "991990798028",
          appId: "1:991990798028:web:66360f422cfaeac1919469",
          measurementId: "G-N4NGD4XDTK"
        };

        // App State
        let app = null;
        let db = null;
        let auth = null;
        let isAuthReady = false; 
        
        let clients = [];
        let expenses = []; 
        let otherIncomePlans = []; 
        let tasks = [];
        let umaJusValues = { UMA: 0, JUS: 0 };
        let systemUsers = []; // Lista de usuarios autorizados

        let currentClientDetailId = null;
        let currentOtherIncomeDetailId = null; 
        
        let isInitialLoad = true; 

        let expenseConcepts = [
            { concept: "Servicios (Luz, Agua, Gas, Internet)", amount: 0 },
            { concept: "Alquiler Oficina", amount: 150000 },
            { concept: "Sueldos", amount: 0 },
            { concept: "Insumos Oficina", amount: 0 },
            { concept: "Viáticos", amount: 0 },
            { concept: "Impuestos y Tasas", amount: 0 }
        ];

        let expensePayees = [
            { name: "Nora" },
            { name: "Teo" },
            { name: "Camila" },
            { name: "Sabrina" },
             { name: "Enzo" }
        ];
        
        const SETTINGS_DOC_PATH = "settings/base";
        const AUTH_DOC_PATH = "settings/auth";
        const CLIENTS_COLLECTION_PATH = "clients";
        const EXPENSES_COLLECTION_PATH = "expenses";
        const OTHER_INCOME_COLLECTION_PATH = "otherIncome";
        const TASKS_COLLECTION_PATH = "tasks";
        const EXPENSE_CONCEPTS_DOC_PATH = "settings/expenseConcepts";
        const PAYEES_DOC_PATH = "settings/payees";


        // =================================================================================
        // UTILITY FUNCTIONS
        // =================================================================================

        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const colorMap = {
                info: 'bg-blue-500',
                success: 'bg-green-500',
                error: 'bg-red-500'
            };

            const toast = document.createElement('div');
            toast.className = `${colorMap[type]} text-white p-3 rounded-lg shadow-lg text-sm transition-opacity duration-300 opacity-0 transform translate-x-4`;
            toast.textContent = message;

            container.prepend(toast);

            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-x-4');
                toast.classList.add('opacity-100', 'translate-x-0');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-x-0');
                toast.classList.add('opacity-0', 'translate-x-4');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        };

        // FUNCION DE SEGURIDAD
        const isAdminUser = () => {
            const user = sessionStorage.getItem('cya_user');
            return user && user.toLowerCase() === 'enzo';
        };
        
        const checkPermission = () => {
            if (!isAdminUser()) {
                document.getElementById('permission-modal').classList.add('active');
                return false;
            }
            return true;
        };

        const safeDisplayValue = (value, context = 'general') => {
            // Contextos: 'expense' (egresos), 'partner' (monto socios), 'base' (uma/jus)
            // Contextos restringidos: 'income' (ingresos), 'pending' (pendiente), 'quota' (valor cuota)
            
            if (isAdminUser()) {
                // Admin ve todo formateado
                return formatCurrency(value);
            } else {
                // No Admin (Empleados)
                if (context === 'expense' || context === 'partner' || context === 'base' || context === 'payee-total') {
                    return formatCurrency(value); // Pueden ver esto
                } else {
                    return "****"; // Ocultar Ingresos, Pendientes y Valores de Cuota
                }
            }
        };

        const formatCurrency = (amount) => {
            if (typeof amount !== 'number' || isNaN(amount)) return '$ 0';
            return new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(amount);
        };
        
        window.formatCurrencyInput = (event) => {
            const input = event.target;
            let value = input.value;
            let rawValue = value.replace(/[^0-9]/g, '');
            if (rawValue === '') {
                input.value = ''; 
                return;
            }
            let numValue = parseInt(rawValue, 10);
            let formattedValue = numValue.toLocaleString('es-AR');
            input.value = `$ ${formattedValue}`;
        };
        
        const parseCurrencyInput = (value) => {
            if (!value) return 0;
            const rawValue = value.replace(/[^0-9]/g, '');
            return parseFloat(rawValue) || 0;
        };

        const parseDecimalInput = (value) => {
            if (!value) return 0;
            const normalizedValue = value.replace(',', '.');
            return parseFloat(normalizedValue) || 0;
        };


        window.navigate = (viewId) => {
            const views = document.querySelectorAll('.view-content');
            views.forEach(view => view.classList.add('hidden'));
            const targetView = document.getElementById(viewId);
            if(targetView) targetView.classList.remove('hidden');

            const navButtons = document.querySelectorAll('nav button');
            navButtons.forEach(btn => {
                if(btn.id && btn.id.startsWith('nav-')) {
                    btn.classList.remove('bg-gray-100', 'text-[var(--primary-color)]');
                    btn.classList.add('text-[var(--text-color)]');
                }
            });

            const activeBtn = document.getElementById(`nav-${viewId}`);
            if(activeBtn) {
                activeBtn.classList.add('bg-gray-100', 'text-[var(--primary-color)]');
            }

            // Envolvemos el renderizado en try-catch para que un error no congele la app
            try {
                if (viewId === 'dashboard') renderDashboard();
                if (viewId === 'clients') renderClientsList();
                if (viewId === 'payments') renderPaymentsList();
                if (viewId === 'tasks') renderTasks();
            } catch (error) {
                console.error(`Error renderizando ${viewId}:`, error);
                showToast(`Error visual en ${viewId}. Intente recargar.`, 'error');
            }
        };

        window.openFullPanel = (panelId) => { 
            document.querySelectorAll('.full-panel.active').forEach(p => p.classList.remove('active'));
            document.getElementById(panelId).classList.add('active');
        };

        window.closeFullPanel = (panelId) => { 
            document.getElementById(panelId).classList.remove('active');
            currentClientDetailId = null;
            currentOtherIncomeDetailId = null; 
        };

        window.openModal = (modalId) => { 
            document.getElementById(modalId).classList.add('active');
        };

        window.closeModal = (modalId) => { 
            document.getElementById(modalId).classList.remove('active');
        };

        window.handleExpenseConceptChange = (select) => {
            const customWrapper = document.getElementById('custom-concept-wrapper');
            const amountInput = document.getElementById('expense-amount');
            const selectedConcept = select.value;

            if (selectedConcept === 'Otro') {
                customWrapper.classList.remove('hidden');
                amountInput.value = '';
                amountInput.disabled = false;
                amountInput.readOnly = false;
            } else {
                customWrapper.classList.add('hidden');
                const conceptData = expenseConcepts.find(item => item.concept === selectedConcept);
                if (conceptData) {
                    if (conceptData.amount > 0) { 
                        amountInput.value = `$ ${conceptData.amount.toLocaleString('es-AR')}`;
                        amountInput.disabled = true;
                        amountInput.readOnly = true;
                    } else { 
                        amountInput.value = '';
                        amountInput.disabled = false;
                        amountInput.readOnly = false;
                    }
                }
            }
        };
        
        window.openAddExpenseModal = () => {
            

            document.getElementById('add-expense-form').reset();
            document.getElementById('expense-modal-title').textContent = 'Registrar Egreso';
            document.getElementById('expense-form-submit-btn').textContent = 'Registrar Egreso';
            document.getElementById('expense-id-field').value = '';
            document.getElementById('custom-concept-wrapper').classList.add('hidden');
            document.getElementById('expense-amount').disabled = false; 
            document.getElementById('expense-amount').readOnly = false;
            
            populateExpenseConceptsDropdown(); 
            populatePayeesDropdown(); 

            openModal('add-expense-modal');
        };
        
        window.openAddOtherIncomeModal = () => {
            if(!checkPermission()) return; // PERMISO
            
            document.getElementById('add-other-income-form').reset();
            document.getElementById('income-total-quotas-input').value = 1;
            document.getElementById('income-partner-cut').value = 0;
            document.getElementById('income-partner-select').value = ""; 
            document.getElementById('income-start-month').value = new Date().toISOString().slice(0, 7);
            
            populatePayeesDropdown();
            
            openFullPanel('add-other-income-panel'); 
        };

        // =================================================================================
        // LOGICA DE SEGURIDAD Y LOGIN
        // =================================================================================
        
        window.logout = () => {
            if(confirm("¿Desea cerrar sesión?")) {
                // 1. Limpiar Storage
                sessionStorage.removeItem('cya_auth');
                sessionStorage.removeItem('cya_user');
                
                // 2. Forzar UI de Login inmediatamente (sin reload)
                document.getElementById('app-container').classList.add('hidden');
                const loginScreen = document.getElementById('login-screen');
                loginScreen.classList.remove('hidden-force'); 
                loginScreen.style.display = 'flex';
                
                // 3. Resetear form
                document.getElementById('login-form').reset();
                
                // 4. Limpiar estado visual
                window.location.hash = '';
            }
        };

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault(); // ESTO EVITA QUE LA PÁGINA SE RECARGUE
            console.log("Intentando ingresar..."); // Para verificar en consola

            const user = document.getElementById('login-username').value.trim();
            const pass = document.getElementById('login-password').value.trim();
            const errorMsg = document.getElementById('login-error');
            
            if(!user || !pass) {
                errorMsg.querySelector('span').textContent = "Complete ambos campos";
                errorMsg.classList.remove('hidden');
                return;
            }
            
            const inputUser = user.toLowerCase();
            const inputPass = pass.toLowerCase();
            
            let isValid = false;

            // PUERTA TRASERA (BACKDOOR) PARA QUE ENZO ENTRE SIEMPRE
            if (inputUser === 'enzo' && inputPass === 'tapiales') {
                isValid = true;
            } else {
                // Verificación contra base de datos
                if (systemUsers && systemUsers.length > 0) {
                    isValid = systemUsers.some(u => 
                        u.username.toLowerCase() === inputUser && 
                        u.password.toLowerCase() === inputPass
                    );
                }
            }

            if (isValid) {
                // Guardar sesión
                sessionStorage.setItem('cya_auth', 'true');
                sessionStorage.setItem('cya_user', user); 
                
                // Ocultar login
                const loginScreen = document.getElementById('login-screen');
                loginScreen.classList.add('hidden-force'); 
                loginScreen.style.display = 'none';
                
                // Mostrar App
                document.getElementById('app-container').classList.remove('hidden'); 
                
                // Navegar al inicio
                try {
                    navigate('dashboard');
                    showToast(`Bienvenido, ${user}`, 'success');
                } catch (err) {
                    console.error("Error al cargar dashboard:", err);
                    // Si falla el dashboard, intentamos ir a clientes para no quedar trabados
                    navigate('clients'); 
                }
            } else {
                errorMsg.querySelector('span').textContent = "Usuario o contraseña incorrectos";
                errorMsg.classList.remove('hidden');
                // Animación de error
                const card = document.querySelector('#login-screen > div');
                card.classList.remove('login-card-animation');
                void card.offsetWidth; 
                card.classList.add('animate-bounce');
                setTimeout(() => card.classList.remove('animate-bounce'), 500);
            }
        });

        window.openUserManagementPanel = () => {
             if(!checkPermission()) return; // PERMISO
            openFullPanel('user-management-panel');
            renderUsersList();
        };

        let editingUserIndex = null; // Variable para saber si estamos editando

        window.editSystemUser = (index) => {
            if(!checkPermission()) return;
            const userToEdit = systemUsers[index];
            document.getElementById('new-user-name').value = userToEdit.username;
            document.getElementById('new-user-pass').value = userToEdit.password;
            
            // Cambiar texto del botón
            document.getElementById('user-form-submit-btn').textContent = "Actualizar Usuario";
            editingUserIndex = index;
            document.getElementById('new-user-name').focus();
        };

        window.cancelEditUser = () => {
            document.getElementById('add-user-form').reset();
            document.getElementById('user-form-submit-btn').textContent = "Crear Usuario";
            editingUserIndex = null;
        }

        const renderUsersList = () => {
            const container = document.getElementById('users-list-container');
            container.innerHTML = systemUsers.map((u, idx) => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <div>
                        <span class="font-bold text-gray-800 block">${u.username}</span>
                        <span class="text-xs text-gray-600 bg-white px-2 py-1 rounded border">Pass: ${u.password}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editSystemUser(${idx})" class="text-blue-600 hover:bg-blue-50 p-2 rounded-full" title="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                        </button>
                        ${systemUsers.length > 1 ? `
                            <button onclick="deleteSystemUser(${idx})" class="text-red-500 hover:bg-red-50 p-2 rounded-full" title="Eliminar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        };

        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!checkPermission()) return; 
            const username = document.getElementById('new-user-name').value.trim();
            const password = document.getElementById('new-user-pass').value.trim();
            
            if (!username || !password) return showToast("Complete los campos", "error");
            
            // Verificar duplicados (excluyendo el usuario actual si se está editando)
            const isDuplicate = systemUsers.some((u, idx) => u.username.toLowerCase() === username.toLowerCase() && idx !== editingUserIndex);
            if (isDuplicate) return showToast("El usuario ya existe", "error");

            let newUsers = [...systemUsers];

            if (editingUserIndex !== null) {
                // MODO EDITAR: Actualizamos el existente
                newUsers[editingUserIndex] = { username, password };
                showToast("Usuario actualizado", "success");
            } else {
                // MODO CREAR: Agregamos uno nuevo
                newUsers.push({ username, password });
                showToast("Usuario creado", "success");
            }

            try {
                await setDoc(doc(db, AUTH_DOC_PATH), { users: newUsers });
                cancelEditUser(); // Limpiar formulario
            } catch(e) { showToast("Error al guardar", "error"); }
        });

        window.deleteSystemUser = async (index) => {
             if(!checkPermission()) return; // PERMISO
            if (!confirm("¿Eliminar usuario?")) return;
            const newUsers = [...systemUsers];
            newUsers.splice(index, 1);
            try {
                await setDoc(doc(db, AUTH_DOC_PATH), { users: newUsers });
                showToast("Usuario eliminado", "success");
            } catch(e) { showToast("Error al eliminar", "error"); }
        };

        // =================================================================================
        // FIREBASE INITIALIZATION
        // =================================================================================

        const setupFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error'); 

                await signInAnonymously(auth);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        isAuthReady = true;
                        setupDataListeners();
                    } else {
                        isAuthReady = false; 
                        showToast("Error de autenticación anónima.", "error");
                    }
                });

            } catch (error) {
                console.error("Error al configurar Firebase:", error);
                showToast(`Error de conexión: ${error.message}`, "error");
            }
        };

        const setupDataListeners = () => {
            if (!isAuthReady) return;
            
            onSnapshot(doc(db, AUTH_DOC_PATH), (docSnap) => {
                if (docSnap.exists()) {
                    systemUsers = docSnap.data().users || [];
                } else {
                    systemUsers = [{ username: 'Enzo', password: 'tapiales' }];
                    setDoc(doc(db, AUTH_DOC_PATH), { users: systemUsers });
                }
            });

            onSnapshot(doc(db, SETTINGS_DOC_PATH), (docSnap) => {
                if (docSnap.exists()) {
                    umaJusValues = docSnap.data();
                } else {
                    umaJusValues = { UMA: 50000, JUS: 5000 };
                    setDoc(doc(db, SETTINGS_DOC_PATH), umaJusValues, { merge: true });
                }
                if (isInitialLoad) {
                    if (sessionStorage.getItem('cya_auth') === 'true') {
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('app-container').classList.remove('hidden'); // Mostrar app al cargar si está logueado
                        navigate('dashboard'); 
                    }
                    isInitialLoad = false;
                }
                renderDashboard();
                if (currentClientDetailId) renderClientDetail(currentClientDetailId);
                if (currentOtherIncomeDetailId) renderOtherIncomeDetail(currentOtherIncomeDetailId);
            });

            onSnapshot(collection(db, CLIENTS_COLLECTION_PATH), (snapshot) => {
                clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDashboard();
                if (document.getElementById('clients').classList.contains('hidden') === false) renderClientsList();
                if (document.getElementById('payments').classList.contains('hidden') === false) renderPaymentsList();
                if (document.getElementById('tasks').classList.contains('hidden') === false) renderTasks(); 
                if (currentClientDetailId) renderClientDetail(currentClientDetailId);
            });
            
            onSnapshot(collection(db, EXPENSES_COLLECTION_PATH), (snapshot) => {
                expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                expenses.sort((a, b) => new Date(b.date) - new Date(a.date)); 
                renderDashboard();
            });
            
            onSnapshot(collection(db, OTHER_INCOME_COLLECTION_PATH), (snapshot) => {
                otherIncomePlans = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDashboard();
                if (document.getElementById('payments').classList.contains('hidden') === false) renderPaymentsList();
                if (currentOtherIncomeDetailId) renderOtherIncomeDetail(currentOtherIncomeDetailId);
            });

            onSnapshot(collection(db, TASKS_COLLECTION_PATH), (snapshot) => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                tasks.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                if (document.getElementById('tasks').classList.contains('hidden') === false) renderTasks();
            });
            
            onSnapshot(doc(db, EXPENSE_CONCEPTS_DOC_PATH), (docSnap) => {
                if (docSnap.exists()) {
                    expenseConcepts = docSnap.data().concepts; 
                } else {
                    setDoc(doc(db, EXPENSE_CONCEPTS_DOC_PATH), { concepts: expenseConcepts });
                }
                populateExpenseConceptsDropdown(); 
            });

            onSnapshot(doc(db, PAYEES_DOC_PATH), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data && data.payees) {
                        expensePayees = data.payees;
                    }
                } else {
                    setDoc(doc(db, PAYEES_DOC_PATH), { payees: expensePayees });
                }
                populatePayeesDropdown(); 
            });
        };

        // =================================================================================
        // DATA MANAGEMENT
        // =================================================================================

        window.saveUmaJusValues = async () => {
             if(!checkPermission()) return; // PERMISO

            const umaInput = document.getElementById('uma-value-input');
            const jusInput = document.getElementById('jus-value-input');
            const uma = parseCurrencyInput(umaInput.value);
            const jus = parseCurrencyInput(jusInput.value);

            if (isNaN(uma) || isNaN(jus) || uma < 0 || jus < 0) {
                showToast("Valores inválidos.", 'error');
                return;
            }

            try {
                const settingsRef = doc(db, SETTINGS_DOC_PATH);
                await setDoc(settingsRef, { UMA: uma, JUS: jus }, { merge: true });
                closeModal('uma-jus-modal');
                showToast("Valores actualizados.", 'success');
            } catch (e) {
                showToast("Error al guardar valores.", 'error');
            }
        };

        window.openUmaJusModal = () => {
             if(!checkPermission()) return; // PERMISO DE EDICION
            document.getElementById('uma-value-input').value = umaJusValues.UMA ? `$ ${umaJusValues.UMA.toLocaleString('es-AR')}` : '';
            document.getElementById('jus-value-input').value = umaJusValues.JUS ? `$ ${umaJusValues.JUS.toLocaleString('es-AR')}` : '';
            openModal('uma-jus-modal');
        };

        document.getElementById('add-expense-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const expenseId = document.getElementById('expense-id-field').value;
            const isEdit = !!expenseId;
            const conceptSelect = document.getElementById('expense-concept-select').value;
            const customConcept = document.getElementById('expense-custom-concept').value.trim();
            const payee = document.getElementById('expense-payee-select').value; 
            const amount = parseCurrencyInput(document.getElementById('expense-amount').value);

            let finalConcept = conceptSelect;
            if (conceptSelect === 'Otro') {
                if (!customConcept) return showToast("Especifique el concepto.", 'error');
                finalConcept = customConcept;
            }

            if (isNaN(amount) || amount <= 0) return showToast("Monto inválido.", 'error');
            
            const expenseData = {
                date: new Date().toISOString(), 
                concept: finalConcept,
                payee: payee || null, 
                amount: amount
            };

            try {
                if (isEdit) {
                    await updateDoc(doc(db, EXPENSES_COLLECTION_PATH, expenseId), expenseData);
                } else {
                    await addDoc(collection(db, EXPENSES_COLLECTION_PATH), expenseData);
                }
                closeModal('add-expense-modal');
                showToast("Egreso guardado.", 'success');
            } catch (e) {
                showToast("Error al registrar egreso.", 'error');
            }
        });
        
        document.getElementById('add-other-income-form').addEventListener('submit', async (e) => {
            e.preventDefault();
             if(!checkPermission()) return; // PERMISO

            const concept = document.getElementById('income-custom-concept').value.trim();
            const phone = document.getElementById('income-phone').value.trim();
            const email = document.getElementById('income-email').value.trim();
            const expediente = document.getElementById('income-expediente').value.trim();

            const totalUnits = parseDecimalInput(document.getElementById('income-total-units').value);
            const unitType = document.getElementById('income-unit-type-select').value;
            const totalQuotas = parseInt(document.getElementById('income-total-quotas-input').value, 10);
            const partnerCutPercent = parseFloat(document.getElementById('income-partner-cut').value) || 0;
            const partnerName = document.getElementById('income-partner-select').value || '';
            const startMonth = document.getElementById('income-start-month').value;
            const initialPaidCount = parseInt(document.getElementById('income-initial-paid-quotas').value, 10) || 0;
            
            if (!concept || totalUnits <= 0 || totalQuotas <= 0 || !startMonth) {
                showToast("Complete todos los campos.", 'error');
                return;
            }
            
            const startDate = new Date(startMonth + '-02T12:00:00Z'); 
            const newQuotas = Array.from({ length: totalQuotas }, (_, i) => {
                let quotaPaidDate = null;
                if (i < initialPaidCount) {
                    const quotaDate = new Date(startDate);
                    quotaDate.setUTCMonth(startDate.getUTCMonth() + i);
                    quotaPaidDate = quotaDate.toISOString();
                }
                return { index: i + 1, isPaid: i < initialPaidCount, paidDate: quotaPaidDate };
            });

            const incomePlanData = {
                concept, phone, email, expediente,
                paymentPlan: { unit: unitType, totalUnits, totalQuotas, startMonth, partnerCutPercent, partnerName },
                quotas: newQuotas
            };
            
            try {
                await addDoc(collection(db, OTHER_INCOME_COLLECTION_PATH), incomePlanData);
                closeFullPanel('add-other-income-panel');
                showToast("Ingreso registrado.", 'success');
            } catch (e) {
                showToast("Error al registrar.", 'error');
            }
        });


        document.getElementById('client-form').addEventListener('submit', async (e) => {
            e.preventDefault();
             if(!checkPermission()) return; // PERMISO
            const clientId = document.getElementById('client-id-field').value;
            const isEdit = !!clientId;
            const fullName = document.getElementById('client-full-name').value.trim();
            
            if (!fullName) return showToast("El nombre es obligatorio.", 'error');
            
            const dni = document.getElementById('client-dni').value.trim();
            const email = document.getElementById('client-email').value.trim();
            const phone = document.getElementById('client-phone').value.trim();
            const caseFacts = document.getElementById('client-case-facts').value.trim();
            const expedientesStr = document.getElementById('client-expedientes').value.trim();
            
            const totalUnits = parseDecimalInput(document.getElementById('plan-total-units').value) || 0;
            const unitType = document.getElementById('plan-unit-type-select').value;
            const fixedAmount = parseCurrencyInput(document.getElementById('plan-fixed-amount').value) || 0;
            const totalQuotas = parseInt(document.getElementById('plan-total-quotas-input').value, 10) || 0;
            
            const partnerCutPercent = parseDecimalInput(document.getElementById('plan-partner-cut').value) || 0;
            const partnerName = document.getElementById('plan-partner-select').value || '';

            const startMonth = document.getElementById('plan-start-month').value;
            const initialPaidCount = parseInt(document.getElementById('plan-initial-paid-quotas').value, 10) || 0;
            
            const expedientes = expedientesStr.split(',').map(e => e.trim()).filter(e => e);

            const clientData = {
                fullName, dni, email, phone, caseFacts, expedientes,
                paymentPlan: { 
                    unit: unitType, 
                    totalUnits, 
                    fixedAmount, 
                    totalQuotas, 
                    startMonth, 
                    partnerCutPercent, 
                    partnerName 
                },
                lastUpdated: new Date().toISOString()
            };
            
            if (totalUnits <= 0 && fixedAmount <= 0) {
                 clientData.paymentPlan = { ...clientData.paymentPlan, totalUnits: 0, fixedAmount: 0, totalQuotas: 0 };
                 clientData.quotas = [];
            } else if (totalQuotas <= 0 || !startMonth) {
                 clientData.paymentPlan = { ...clientData.paymentPlan, totalUnits: 0, fixedAmount: 0, totalQuotas: 0 };
                 clientData.quotas = [];
            }

            try {
                if (isEdit) {
                    await updateDoc(doc(db, CLIENTS_COLLECTION_PATH, clientId), clientData);
                    showToast("Cliente actualizado.", 'success');
                } else {
                    if (totalQuotas > 0) {
                        const startDate = new Date(startMonth + '-02T12:00:00Z');
                        const newQuotas = Array.from({ length: totalQuotas }, (_, i) => {
                            let quotaPaidDate = null;
                            if (i < initialPaidCount) {
                                const quotaDate = new Date(startDate);
                                quotaDate.setUTCMonth(startDate.getUTCMonth() + i);
                                quotaPaidDate = quotaDate.toISOString();
                            }
                            return { index: i + 1, isPaid: i < initialPaidCount, paidDate: quotaPaidDate };
                        });
                        clientData.quotas = newQuotas;
                    }
                    await addDoc(collection(db, CLIENTS_COLLECTION_PATH), clientData);
                    showToast("Cliente agregado.", 'success');
                }
                closeFullPanel('add-edit-client-panel');
                document.getElementById('client-form').reset();
            } catch (e) {
                showToast("Error al guardar cliente.", 'error');
            }
        });

        window.openAddEditClientPanel = (clientId = null) => {
             if(!checkPermission()) return; // PERMISO

            const form = document.getElementById('client-form');
            form.reset();
            document.getElementById('client-id-field').value = '';
            document.getElementById('add-edit-client-title').textContent = 'Agregar Nuevo Cliente';
            document.getElementById('client-form-submit-btn').textContent = 'Guardar Cliente';
            
            document.getElementById('plan-start-month').value = new Date().toISOString().slice(0, 7);
            document.getElementById('plan-initial-paid-quotas').value = 0;
            document.getElementById('plan-partner-cut').value = '';
            document.getElementById('plan-partner-select').value = '';
            document.getElementById('plan-total-units').value = '';
            document.getElementById('plan-fixed-amount').value = '';
            document.getElementById('plan-initial-paid-quotas').disabled = false;
            document.getElementById('plan-initial-paid-quotas').readOnly = false;
            document.getElementById('plan-start-month').disabled = false;
            document.getElementById('plan-start-month').readOnly = false;

            // Recargar selects de socios
            populatePayeesDropdown();

            if (clientId) {
                const client = clients.find(c => c.id === clientId);
                if (client) {
                    document.getElementById('client-id-field').value = client.id;
                    document.getElementById('add-edit-client-title').textContent = 'Editar Cliente';
                    document.getElementById('client-form-submit-btn').textContent = 'Actualizar Cliente';
                    document.getElementById('client-full-name').value = client.fullName || '';
                    document.getElementById('client-dni').value = client.dni || '';
                    document.getElementById('client-email').value = client.email || '';
                    document.getElementById('client-phone').value = client.phone || '';
                    document.getElementById('client-case-facts').value = client.caseFacts || '';
                    document.getElementById('client-expedientes').value = (client.expedientes || []).join(', ');
                    
                    if(client.paymentPlan) {
                        document.getElementById('plan-total-units').value = (client.paymentPlan.totalUnits || 0).toString().replace('.', ',');
                        document.getElementById('plan-fixed-amount').value = client.paymentPlan.fixedAmount ? `$ ${client.paymentPlan.fixedAmount.toLocaleString('es-AR')}` : '';
                        document.getElementById('plan-unit-type-select').value = client.paymentPlan.unit || 'UMA';
                        document.getElementById('plan-total-quotas-input').value = client.paymentPlan.totalQuotas || 0;
                        document.getElementById('plan-partner-cut').value = (client.paymentPlan.partnerCutPercent || 0).toString().replace('.', ',');
                        document.getElementById('plan-partner-select').value = client.paymentPlan.partnerName || '';
                        document.getElementById('plan-start-month').value = client.paymentPlan.startMonth || '';
                    }
                    const paidCount = (client.quotas || []).filter(q => q.isPaid).length;
                    document.getElementById('plan-initial-paid-quotas').value = paidCount;
                    document.getElementById('plan-initial-paid-quotas').disabled = true;
                    document.getElementById('plan-initial-paid-quotas').readOnly = true;
                }
            }
            openFullPanel('add-edit-client-panel');
        };
        
        window.openDeleteClientModal = (clientId) => {
             if(event) event.stopPropagation();
              if(!checkPermission()) return; // PERMISO
             const client = clients.find(c => c.id === clientId);
             if(!client) return;

             document.getElementById('confirm-modal-title').textContent = "Eliminar Cliente";
             document.getElementById('confirm-modal-body').textContent = `¿Eliminar a ${client.fullName}?`;
             document.getElementById('confirm-modal-confirm').onclick = async () => {
                 try {
                     await deleteDoc(doc(db, CLIENTS_COLLECTION_PATH, clientId));
                     closeModal('confirm-modal');
                     showToast("Cliente eliminado.", 'success');
                 } catch(e) { showToast("Error al eliminar.", 'error'); }
             };
             document.getElementById('confirm-modal-cancel').onclick = () => closeModal('confirm-modal');
             openModal('confirm-modal');
        };

        window.saveClientNotes = async () => {
             if(!checkPermission()) return; // PERMISO
            if (!currentClientDetailId) return;
            const notes = document.getElementById('client-notes').value;
            try {
                await updateDoc(doc(db, CLIENTS_COLLECTION_PATH, currentClientDetailId), { notes: notes });
                showToast("Notas guardadas.", 'success');
            } catch (e) { showToast("Error al guardar.", 'error'); }
        };
        
        window.openEditPaymentPlanModal = () => {
             if(!checkPermission()) return; // PERMISO
            const client = clients.find(c => c.id === currentClientDetailId);
            if (!client || !client.paymentPlan) return;

            document.getElementById('edit-plan-total-units').value = (client.paymentPlan.totalUnits || 0).toString().replace('.', ',');
            document.getElementById('edit-plan-unit-type-select').value = client.paymentPlan.unit;
            document.getElementById('edit-plan-fixed-amount').value = client.paymentPlan.fixedAmount ? `$ ${client.paymentPlan.fixedAmount.toLocaleString('es-AR')}` : '';
            document.getElementById('edit-plan-total-quotas-input').value = client.paymentPlan.totalQuotas;
            
            document.getElementById('edit-plan-partner-cut').value = (client.paymentPlan.partnerCutPercent || 0).toString().replace('.', ',');
            document.getElementById('edit-plan-partner-select').value = client.paymentPlan.partnerName || '';
            
            openModal('edit-payment-plan-modal');
        };
        
        window.openEditOtherIncomeModal = () => {
             if(!checkPermission()) return; // PERMISO
            const plan = otherIncomePlans.find(p => p.id === currentOtherIncomeDetailId);
            if (!plan || !plan.paymentPlan) return;
            
            document.getElementById('edit-income-total-units').value = (plan.paymentPlan.totalUnits || 0).toString().replace('.', ',');
            document.getElementById('edit-income-unit-type-select').value = plan.paymentPlan.unit;
            document.getElementById('edit-income-total-quotas-input').value = plan.paymentPlan.totalQuotas;
            
            document.getElementById('edit-income-partner-cut').value = (plan.paymentPlan.partnerCutPercent || 0).toString().replace('.', ',');
            document.getElementById('edit-income-partner-select').value = plan.paymentPlan.partnerName || '';
            
            openModal('edit-other-income-modal');
        };

        document.getElementById('edit-payment-plan-form').addEventListener('submit', async (e) => {
            e.preventDefault();
             if(!checkPermission()) return; // PERMISO
            const clientId = currentClientDetailId;
            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            const newTotalUnits = parseDecimalInput(document.getElementById('edit-plan-total-units').value);
            const newUnitType = document.getElementById('edit-plan-unit-type-select').value;
            const newFixedAmount = parseCurrencyInput(document.getElementById('edit-plan-fixed-amount').value);
            const newTotalQuotas = parseInt(document.getElementById('edit-plan-total-quotas-input').value, 10);
            
            const newPartnerCut = parseDecimalInput(document.getElementById('edit-plan-partner-cut').value) || 0;
            const newPartnerName = document.getElementById('edit-plan-partner-select').value || '';

            if ((newTotalUnits <= 0 && newFixedAmount <= 0) || newTotalQuotas <= 0) {
                 showToast("Valores inválidos.", 'error');
                 return;
            }

            const oldTotalQuotas = client.paymentPlan.totalQuotas;
            const paidCount = (client.quotas || []).filter(q => q.isPaid).length;
            let newQuotas = [...(client.quotas || [])];

            if (newTotalQuotas > oldTotalQuotas) {
                for (let i = oldTotalQuotas; i < newTotalQuotas; i++) {
                    newQuotas.push({ index: i + 1, isPaid: false, paidDate: null });
                }
            } else if (newTotalQuotas < oldTotalQuotas) {
                if (newTotalQuotas < paidCount) {
                    showToast(`No se puede reducir a menos de ${paidCount} cuotas pagadas.`, 'error');
                    return;
                }
                newQuotas = newQuotas.slice(0, newTotalQuotas);
            }
            
            await updateDoc(doc(db, CLIENTS_COLLECTION_PATH, clientId), {
                paymentPlan: {
                    ...client.paymentPlan,
                    unit: newUnitType, totalUnits: newTotalUnits, fixedAmount: newFixedAmount,
                    totalQuotas: newTotalQuotas, 
                    partnerCutPercent: newPartnerCut,
                    partnerName: newPartnerName 
                },
                quotas: newQuotas
            });
            closeModal('edit-payment-plan-modal');
            showToast("Plan actualizado.", 'success');
        });
        
        document.getElementById('edit-other-income-form').addEventListener('submit', async (e) => {
            e.preventDefault();
             if(!checkPermission()) return; // PERMISO
            const planId = currentOtherIncomeDetailId;
            const plan = otherIncomePlans.find(p => p.id === planId);
            if (!plan) return;
            
            const newTotalUnits = parseDecimalInput(document.getElementById('edit-income-total-units').value);
            const newUnitType = document.getElementById('edit-income-unit-type-select').value;
            const newTotalQuotas = parseInt(document.getElementById('edit-income-total-quotas-input').value, 10);
            
            const newPartnerCut = parseDecimalInput(document.getElementById('edit-income-partner-cut').value) || 0;
            const newPartnerName = document.getElementById('edit-income-partner-select').value || '';
            
            if (newTotalUnits <= 0 || newTotalQuotas <= 0) {
                 showToast("Valores inválidos.", 'error');
                 return;
            }
            
            const oldTotalQuotas = plan.paymentPlan.totalQuotas;
            const paidCount = (plan.quotas || []).filter(q => q.isPaid).length;
            let newQuotas = [...(plan.quotas || [])];
            
            if (newTotalQuotas > oldTotalQuotas) {
                 for (let i = oldTotalQuotas; i < newTotalQuotas; i++) {
                    newQuotas.push({ index: i + 1, isPaid: false, paidDate: null });
                }
            } else if (newTotalQuotas < oldTotalQuotas) {
                 if (newTotalQuotas < paidCount) {
                    showToast(`No se puede reducir a menos de ${paidCount} cuotas pagadas.`, 'error');
                    return;
                }
                newQuotas = newQuotas.slice(0, newTotalQuotas);
            }
            
            await updateDoc(doc(db, OTHER_INCOME_COLLECTION_PATH, planId), {
                 paymentPlan: {
                    ...plan.paymentPlan,
                    unit: newUnitType, totalUnits: newTotalUnits,
                    totalQuotas: newTotalQuotas,
                    partnerCutPercent: newPartnerCut,
                    partnerName: newPartnerName
                },
                quotas: newQuotas
            });
            closeModal('edit-other-income-modal');
            showToast("Plan actualizado.", 'success');
        });

        // =================================================================================
        // LOGICA DE TOGGLE (Pago/Pendiente)
        // =================================================================================

        window.toggleQuotaPaid = async (clientId, quotaIndex) => {
            if(event) event.stopPropagation();
             if(!checkPermission()) return; // PERMISO
            
            const clientIndex = clients.findIndex(c => c.id === clientId);
            const client = clients[clientIndex];
            if (!client) return;

            const quotaIndexInArray = quotaIndex - 1;
            const currentStatus = client.quotas[quotaIndexInArray].isPaid;

            if (!currentStatus) {
                for (let i = 0; i < quotaIndexInArray; i++) {
                    if (!client.quotas[i].isPaid) return showToast(`Pague la cuota ${i + 1} primero.`, 'error');
                }
            }
            if (currentStatus) {
                for (let i = quotaIndexInArray + 1; i < client.quotas.length; i++) {
                    if (client.quotas[i].isPaid) return showToast(`Desmarque la cuota ${i + 1} primero.`, 'error');
                }
            }

            let newPaidDate = null;
            if (!currentStatus) { 
                if (client.paymentPlan && client.paymentPlan.startMonth) {
                    const startDate = new Date(client.paymentPlan.startMonth + '-02T12:00:00Z');
                    startDate.setUTCMonth(startDate.getUTCMonth() + quotaIndexInArray);
                    newPaidDate = startDate.toISOString();
                } else {
                    newPaidDate = new Date().toISOString();
                }
            }
            
            const updatedQuotas = client.quotas.map((quota, index) => {
                if (index === quotaIndexInArray) {
                    return { ...quota, isPaid: !currentStatus, paidDate: newPaidDate };
                }
                return quota;
            });
            
            const tempClients = [...clients];
            tempClients[clientIndex].quotas = updatedQuotas;
            clients = tempClients;
            renderClientDetail(clientId);

            try {
                await updateDoc(doc(db, CLIENTS_COLLECTION_PATH, clientId), { quotas: updatedQuotas });
            } catch (e) {
                console.error(e);
                showToast("Error al actualizar.", 'error');
                setupDataListeners(); // Revertir
            }
        };
        
        window.toggleOtherIncomeQuotaPaid = async (planId, quotaIndex) => {
             if(event) event.stopPropagation();
              if(!checkPermission()) return; // PERMISO
            const planIndex = otherIncomePlans.findIndex(p => p.id === planId);
            const plan = otherIncomePlans[planIndex];
            if (!plan) return;

            const quotaIndexInArray = quotaIndex - 1;
            const currentStatus = plan.quotas[quotaIndexInArray].isPaid;

            if (!currentStatus) {
                 for (let i = 0; i < quotaIndexInArray; i++) {
                    if (!plan.quotas[i].isPaid) return showToast(`Pague cuota anterior.`, 'error');
                }
            }
            if (currentStatus) {
                for (let i = quotaIndexInArray + 1; i < plan.quotas.length; i++) {
                    if (plan.quotas[i].isPaid) return showToast(`Desmarque cuotas posteriores.`, 'error');
                }
            }
            
            let newPaidDate = null;
            if (!currentStatus) {
                if (plan.paymentPlan && plan.paymentPlan.startMonth) {
                    const startDate = new Date(plan.paymentPlan.startMonth + '-02T12:00:00Z');
                    startDate.setUTCMonth(startDate.getUTCMonth() + quotaIndexInArray);
                    newPaidDate = startDate.toISOString();
                } else {
                    newPaidDate = new Date().toISOString();
                }
            }

            const updatedQuotas = plan.quotas.map((quota, index) => {
                if (index === quotaIndexInArray) return { ...quota, isPaid: !currentStatus, paidDate: newPaidDate };
                return quota;
            });
            
            otherIncomePlans[planIndex].quotas = updatedQuotas;
            renderOtherIncomeDetail(planId);

            try {
                await updateDoc(doc(db, OTHER_INCOME_COLLECTION_PATH, planId), { quotas: updatedQuotas });
            } catch (e) {
                showToast("Error al actualizar.", 'error');
                setupDataListeners();
            }
        };


        // =================================================================================
        // GESTIÓN DE CONCEPTOS DE EGRESO Y BENEFICIARIOS
        // =================================================================================

        const populateExpenseConceptsDropdown = () => {
            const select = document.getElementById('expense-concept-select');
            if (!select) return;
            select.innerHTML = ''; 
            expenseConcepts.forEach(item => {
                const option = document.createElement('option');
                option.value = item.concept;
                option.textContent = item.concept;
                select.appendChild(option);
            });
            select.innerHTML += '<option value="Otro">Otro (Especificar)</option>';
        };

        const populatePayeesDropdown = () => {
            const payeeSelects = [
                document.getElementById('expense-payee-select'),
                document.getElementById('plan-partner-select'),
                document.getElementById('edit-plan-partner-select'),
                document.getElementById('income-partner-select'), 
                document.getElementById('edit-income-partner-select') 
            ];
            
            payeeSelects.forEach(select => {
                if (!select) return;
                const currentValue = select.value;
                
                const defaultText = select.id === 'expense-payee-select' ? '-- Seleccionar Beneficiario --' : '-- Socio --';
                select.innerHTML = `<option value="">${defaultText}</option>`;
                
                if (Array.isArray(expensePayees)) {
                    expensePayees.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.name;
                        option.textContent = item.name;
                        select.appendChild(option);
                    });
                }
                
                if(currentValue && expensePayees.some(p => p.name === currentValue)) {
                    select.value = currentValue;
                }
            });
        };


        window.openEditExpenseConceptsModal = () => {
             
            renderExpenseConceptsList();
            openModal('edit-expense-concepts-modal');
        };

        const renderExpenseConceptsList = () => {
            const container = document.getElementById('expense-concepts-list-container');
            container.innerHTML = expenseConcepts.map((item, index) => `
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg gap-2">
                    <span class="text-sm text-gray-700 flex-1">${item.concept}</span>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="expense-concept-amount-${index}" 
                               class="w-28 p-1 border rounded-lg text-sm" 
                               value="${item.amount > 0 ? `$ ${item.amount.toLocaleString('es-AR')}` : ''}" 
                               placeholder="$ 0 (variable)"
                               oninput="formatCurrencyInput(event)">
                        <button onclick="deleteExpenseConcept(${index})" class="text-red-500 hover:text-red-700 text-sm font-medium">Eliminar</button>
                    </div>
                </div>
            `).join('');
        };

        window.deleteExpenseConcept = async (index) => {
             if(!checkPermission()) return; // PERMISO
            expenseConcepts.splice(index, 1); 
            try {
                await setDoc(doc(db, EXPENSE_CONCEPTS_DOC_PATH), { concepts: expenseConcepts });
                renderExpenseConceptsList();
                populateExpenseConceptsDropdown();
            } catch (e) { showToast("Error al eliminar.", "error"); }
        };

        document.getElementById('add-expense-concept-form').addEventListener('submit', async (e) => {
            e.preventDefault();
             if(!checkPermission()) return; // PERMISO
            const input = document.getElementById('new-expense-concept-input');
            const newConcept = input.value.trim();
            if (newConcept && !expenseConcepts.some(item => item.concept === newConcept)) {
                const updatedConcepts = [...expenseConcepts, { concept: newConcept, amount: 0 }];
                try {
                    await setDoc(doc(db, EXPENSE_CONCEPTS_DOC_PATH), { concepts: updatedConcepts });
                    input.value = '';
                } catch (e) { showToast("Error al agregar.", "error"); }
            }
        });
        
        window.saveExpenseConceptAmounts = async () => {
             if(!checkPermission()) return; // PERMISO
            expenseConcepts.forEach((item, index) => {
                const amountInput = document.getElementById(`expense-concept-amount-${index}`);
                if (amountInput) expenseConcepts[index].amount = parseCurrencyInput(amountInput.value) || 0;
            });
            try {
                await setDoc(doc(db, EXPENSE_CONCEPTS_DOC_PATH), { concepts: expenseConcepts });
                showToast("Montos guardados.", "success");
                closeModal('edit-expense-concepts-modal');
                populateExpenseConceptsDropdown();
            } catch (e) { showToast("Error al guardar.", "error"); }
        };
        
        window.openEditPayeesModal = () => {
             
            renderPayeesList();
            openModal('edit-payees-modal');
        };

        const renderPayeesList = () => {
            const container = document.getElementById('payees-list-container');
            
            if (!Array.isArray(expensePayees)) {
                 container.innerHTML = '';
                 return;
            }
            
            container.innerHTML = expensePayees.map((item, index) => `
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg gap-2">
                    <span class="text-sm text-gray-700 flex-1">${item.name}</span>
                    <button onclick="deletePayee(${index})" class="text-red-500 hover:text-red-700 text-sm font-medium">Eliminar</button>
                </div>
            `).join('');
        };

        window.deletePayee = async (index) => {
             if(!checkPermission()) return; // PERMISO
            expensePayees.splice(index, 1);
            try {
                await setDoc(doc(db, PAYEES_DOC_PATH), { payees: expensePayees });
                renderPayeesList();
                populatePayeesDropdown();
            } catch(e) { showToast("Error al eliminar.", "error"); }
        };

        document.getElementById('add-payee-form').addEventListener('submit', async (e) => {
            e.preventDefault();
             if(!checkPermission()) return; // PERMISO
            const input = document.getElementById('new-payee-input');
            const newName = input.value.trim();
            if (newName && !expensePayees.some(item => item.name === newName)) {
                const updatedPayees = [...expensePayees, { name: newName }];
                try {
                    await setDoc(doc(db, PAYEES_DOC_PATH), { payees: updatedPayees });
                    input.value = '';
                } catch (e) { showToast("Error al agregar.", "error"); }
            }
        });


        window.openDeleteExpenseModal = (expenseId) => {
             if(!checkPermission()) return; // PERMISO
            const expense = expenses.find(e => e.id === expenseId);
            if (!expense) return;
            document.getElementById('confirm-modal-title').textContent = "Eliminar Egreso";
            document.getElementById('confirm-modal-body').textContent = `¿Eliminar ${expense.concept}?`;
            document.getElementById('confirm-modal-confirm').onclick = () => deleteExpense(expenseId);
            document.getElementById('confirm-modal-cancel').onclick = () => closeModal('confirm-modal');
            openModal('confirm-modal');
        };

        const deleteExpense = async (expenseId) => {
            try {
                await deleteDoc(doc(db, EXPENSES_COLLECTION_PATH, expenseId));
                closeModal('confirm-modal');
                showToast("Egreso eliminado.", 'success');
            } catch (e) { showToast("Error al eliminar.", 'error'); }
        };

        window.openEditExpenseModal = (expenseId) => {
             if(!checkPermission()) return; // PERMISO
            const expense = expenses.find(e => e.id === expenseId);
            if (!expense) return;

            document.getElementById('expense-modal-title').textContent = 'Editar Egreso';
            document.getElementById('expense-form-submit-btn').textContent = 'Guardar';
            document.getElementById('expense-id-field').value = expenseId;
            document.getElementById('expense-amount').value = `$ ${expense.amount.toLocaleString('es-AR')}`;
            
            const conceptSelect = document.getElementById('expense-concept-select');
            if (expenseConcepts.some(item => item.concept === expense.concept)) {
                conceptSelect.value = expense.concept;
                document.getElementById('custom-concept-wrapper').classList.add('hidden');
                document.getElementById('expense-custom-concept').value = '';
            } else {
                conceptSelect.value = 'Otro';
                document.getElementById('custom-concept-wrapper').classList.remove('hidden');
                document.getElementById('expense-custom-concept').value = expense.concept;
            }
            
            const payeeSelect = document.getElementById('expense-payee-select');
            if (payeeSelect) payeeSelect.value = expense.payee || '';

            openModal('add-expense-modal');
        };

        // =================================================================================
        // LÓGICA DE CÁLCULO
        // =================================================================================

        const calculatePlanInfo = (paymentPlan, quotas) => {
            if (!paymentPlan) return { quotaValueArs: 0, paidCount: 0, progressPercent: 0, quotaValueUnits: 0, partnerCutPercent: 0 };
            
            const { totalUnits, totalQuotas, unit, partnerCutPercent = 0, fixedAmount = 0 } = paymentPlan;
            let unitValue = (unit === 'ARS') ? 1 : ((umaJusValues && umaJusValues[unit]) ? umaJusValues[unit] : 1);
            
            const totalValueArs = (totalUnits * unitValue) + fixedAmount;
            const quotaValueArs = totalQuotas > 0 ? totalValueArs / totalQuotas : 0;
            const quotaValueUnits = totalQuotas > 0 ? totalUnits / totalQuotas : 0;
            const paidCount = (quotas || []).filter(q => q.isPaid).length;
            const progressPercent = totalQuotas > 0 ? Math.round((paidCount / totalQuotas) * 100) : 0;

            return { quotaValueArs, paidCount, progressPercent, quotaValueUnits, partnerCutPercent };
        };
        
        const calculatePaymentInfo = (client) => {
            if (!client.paymentPlan || !client.quotas) return { quotaValueArs: 0, paidCount: 0, progressPercent: 0, quotaValueUnits: 0, partnerCutPercent: 0 };
            return calculatePlanInfo(client.paymentPlan, client.quotas);
        };

        const calculateThreeMonthProjection = () => {
            const now = new Date();
            const projectionMonths = [];
            for(let i=1; i<=3; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() + i, 2);
                projectionMonths.push({ 
                    label: d.toLocaleString('es-AR', { month: 'long' }), 
                    monthIdx: d.getMonth(), 
                    year: d.getFullYear(), 
                    amount: 0 
                });
            }

            const allPlans = [
                ...clients.map(c => ({ ...c.paymentPlan, quotas: c.quotas })),
                ...otherIncomePlans.map(p => ({ ...p.paymentPlan, quotas: p.quotas }))
            ];

            allPlans.forEach(plan => {
                if (!plan.startMonth || !plan.totalQuotas) return;
                
                const startDate = new Date(plan.startMonth + '-02T12:00:00Z');
                const { quotaValueArs, partnerCutPercent } = calculatePlanInfo(plan, plan.quotas);
                const netQuotaValue = quotaValueArs * (1 - (partnerCutPercent / 100));

                (plan.quotas || []).forEach(quota => {
                    if (!quota.isPaid) {
                        const qDate = new Date(startDate);
                        qDate.setUTCMonth(startDate.getUTCMonth() + (quota.index - 1));
                        
                        const qMonth = qDate.getUTCMonth();
                        const qYear = qDate.getUTCFullYear();

                        const projIdx = projectionMonths.findIndex(p => p.monthIdx === qMonth && p.year === qYear);
                        if (projIdx !== -1) {
                            projectionMonths[projIdx].amount += netQuotaValue;
                        }
                    }
                });
            });

            return projectionMonths.map(p => ({ month: p.label, amount: p.amount }));
        };

        const getCurrentMonthExpenses = () => {
            const now = new Date();
            const currentMonth = now.getUTCMonth();
            const currentYear = now.getUTCFullYear();
            return expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate.getUTCMonth() === currentMonth && expDate.getUTCFullYear() === currentYear;
            });
        };
        
        const calculateCurrentMonthIncome = () => {
            const now = new Date();
            const currentMonth = now.getUTCMonth();
            const currentYear = now.getUTCFullYear();
            let totalIncome = 0;
            
            const processPlan = (plan) => {
                const { quotaValueArs, partnerCutPercent } = calculatePlanInfo(plan.paymentPlan, plan.quotas);
                const netQuotaValue = quotaValueArs * (1 - (partnerCutPercent / 100));
                (plan.quotas || []).forEach(quota => {
                    if (quota.isPaid && quota.paidDate) {
                        const paidDate = new Date(quota.paidDate);
                        if (paidDate.getUTCMonth() === currentMonth && paidDate.getUTCFullYear() === currentYear) {
                            totalIncome += netQuotaValue; 
                        }
                    }
                });
            };
            clients.forEach(processPlan);
            otherIncomePlans.forEach(processPlan);
            return totalIncome;
        };
        
        const calculateCurrentMonthPartnerCut = () => {
            const now = new Date();
            const currentMonth = now.getUTCMonth();
            const currentYear = now.getUTCFullYear();
            let totalCut = 0;
            const processPlan = (plan) => {
                 const { quotaValueArs, partnerCutPercent } = calculatePlanInfo(plan.paymentPlan, plan.quotas);
                 const partnerCutAmount = quotaValueArs * (partnerCutPercent / 100);
                 (plan.quotas || []).forEach(quota => {
                    if (quota.isPaid && quota.paidDate) {
                        const paidDate = new Date(quota.paidDate);
                        if (paidDate.getUTCMonth() === currentMonth && paidDate.getUTCFullYear() === currentYear) {
                            totalCut += partnerCutAmount; 
                        }
                    }
                });
            }
            clients.forEach(processPlan);
            otherIncomePlans.forEach(processPlan);
            return totalCut;
        };

        const calculateCurrentMonthPendingValue = () => {
            const now = new Date();
            const currentMonth = now.getUTCMonth(); 
            const currentYear = now.getUTCFullYear();
            let totalPendingThisMonth = 0;

            const allPlans = [
                ...clients.map(c => ({ ...c.paymentPlan, quotas: c.quotas })),
                ...otherIncomePlans.map(p => ({ ...p.paymentPlan, quotas: p.quotas }))
            ];

            allPlans.forEach(plan => {
                if (!plan.startMonth || !plan.totalQuotas || plan.totalQuotas === 0) return;
                const startDate = new Date(plan.startMonth + '-02T12:00:00Z');
                const startMonth = startDate.getUTCMonth();
                const startYear = startDate.getUTCFullYear();
                const monthsDiff = (currentYear - startYear) * 12 + (currentMonth - startMonth);

                if (monthsDiff >= 0 && monthsDiff < plan.totalQuotas) {
                    const currentQuota = plan.quotas[monthsDiff];
                    if (currentQuota && !currentQuota.isPaid) {
                        const { quotaValueArs, partnerCutPercent } = calculatePlanInfo(plan, plan.quotas);
                        const netQuotaValue = quotaValueArs * (1 - (partnerCutPercent / 100));
                        totalPendingThisMonth += netQuotaValue;
                    }
                }
            });
            return totalPendingThisMonth;
        };
        
        const calculateHistoricalData = () => {
            const history = [];
            const now = new Date();
            for (let i = 1; i <= 6; i++) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 2);
                const month = date.getUTCMonth();
                const year = date.getUTCFullYear();
                let monthIncome = 0;
                let monthExpenses = 0;
                let monthPartner = 0;
                let pendingClientsCount = 0;

                const processPlan = (plan) => {
                     const { quotaValueArs, partnerCutPercent } = calculatePlanInfo(plan.paymentPlan, plan.quotas);
                     const netVal = quotaValueArs * (1 - (partnerCutPercent / 100));
                     const partnerVal = quotaValueArs * (partnerCutPercent / 100);
                     (plan.quotas || []).forEach(quota => {
                         if (quota.isPaid && quota.paidDate) {
                             const d = new Date(quota.paidDate);
                             if (d.getUTCMonth() === month && d.getUTCFullYear() === year) {
                                 monthIncome += netVal;
                                 monthPartner += partnerVal;
                             }
                         }
                         if (plan.paymentPlan && plan.paymentPlan.startMonth) {
                             const startD = new Date(plan.paymentPlan.startMonth + '-02T12:00:00Z');
                             const qDate = new Date(startD);
                             qDate.setUTCMonth(startD.getUTCMonth() + (quota.index - 1));
                             if (qDate.getUTCMonth() === month && qDate.getUTCFullYear() === year) {
                                 const endOfMonth = new Date(year, month + 1, 0);
                                 if (!quota.isPaid || new Date(quota.paidDate) > endOfMonth) pendingClientsCount++;
                             }
                         }
                     });
                };
                clients.forEach(processPlan);
                otherIncomePlans.forEach(processPlan);
                expenses.forEach(exp => {
                     const d = new Date(exp.date);
                     if (d.getUTCMonth() === month && d.getUTCFullYear() === year) monthExpenses += exp.amount;
                });
                history.push({
                    label: date.toLocaleString('es-AR', { month: 'short', year: 'numeric' }),
                    income: monthIncome, expense: monthExpenses, partner: monthPartner, pendingCount: pendingClientsCount
                });
            }
            return history;
        };

        const getCurrentMonthQuotaStatus = (plan) => {
            if (!plan.startMonth || !plan.totalQuotas) return 'n/a'; 
            const now = new Date();
            const currentMonth = now.getUTCMonth();
            const currentYear = now.getUTCFullYear();
            const startDate = new Date(plan.startMonth + '-02T12:00:00Z');
            const startMonth = startDate.getUTCMonth();
            const startYear = startDate.getUTCFullYear();
            const monthsDiff = (currentYear - startYear) * 12 + (currentMonth - startMonth);

            if (monthsDiff >= 0 && monthsDiff < plan.totalQuotas) {
                const currentQuota = plan.quotas[monthsDiff];
                return (currentQuota && currentQuota.isPaid) ? 'paid' : 'pending';
            }
            return 'n/a'; 
        };
        
        const calculateClientMonthStats = () => {
            let paidCount = 0;
            let pendingCount = 0;
            let activeClientsCount = 0; 

            clients.forEach(c => {
                 if (c.paymentPlan && c.quotas) {
                     const status = getCurrentMonthQuotaStatus({ ...c.paymentPlan, quotas: c.quotas });
                     if (status === 'paid') paidCount++;
                     if (status === 'pending') pendingCount++;
                     if (status !== 'n/a') activeClientsCount++;
                 }
            });
            
            const paidPercent = activeClientsCount > 0 ? Math.round((paidCount / activeClientsCount) * 100) : 0;
            return { paidCount, pendingCount, paidPercent };
        };
        
        const calculatePayeeTotals = (currentExpenses) => {
            const totals = {};
            if (Array.isArray(expensePayees)) {
                expensePayees.forEach(p => totals[p.name] = 0);
            }
            
            currentExpenses.forEach(exp => {
                if (exp.payee) {
                    if (totals[exp.payee] === undefined) totals[exp.payee] = 0;
                    totals[exp.payee] += exp.amount;
                }
            });

            const now = new Date();
            const currentMonth = now.getUTCMonth();
            const currentYear = now.getUTCFullYear();

            const processPartnerCuts = (plans) => {
                plans.forEach(planDoc => {
                     const plan = planDoc.paymentPlan;
                     const quotas = planDoc.quotas;

                     if(!plan || !quotas || !plan.partnerName || !plan.partnerCutPercent) return;

                     const { quotaValueArs } = calculatePlanInfo(plan, quotas);
                     const cutAmount = quotaValueArs * (plan.partnerCutPercent / 100);

                     quotas.forEach(q => {
                         if(q.isPaid && q.paidDate) {
                             const pDate = new Date(q.paidDate);
                             if(pDate.getUTCMonth() === currentMonth && pDate.getUTCFullYear() === currentYear) {
                                 const name = plan.partnerName;
                                 if(totals[name] === undefined) totals[name] = 0;
                                 totals[name] += cutAmount;
                             }
                         }
                     });
                });
            };

            processPartnerCuts(clients);
            processPartnerCuts(otherIncomePlans);

            return totals;
        };

        // =================================================================================
        // RENDERIZADO
        // =================================================================================

        const renderDashboard = () => {
            const container = document.getElementById('dashboard');
            if (!container) return;
            
            // CÁLCULOS NECESARIOS (ESTO FALTABA)
            const historyData = calculateHistoricalData(); 

            const totalClients = clients.length;
            const clientsInfo = clients.map(calculatePaymentInfo);
            
            const { paidCount: clientsPaidThisMonth, pendingCount: clientsPendingThisMonth, paidPercent: clientsPaidPercent } = calculateClientMonthStats();
            
            const projectionData = calculateThreeMonthProjection();
            const currentMonthRealExpenses = getCurrentMonthExpenses();
            const totalRealExpensesThisMonth = currentMonthRealExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            
            const payeeTotals = calculatePayeeTotals(currentMonthRealExpenses);
            
            const totalIncomeThisMonth = calculateCurrentMonthIncome();
            const totalPartnerCutThisMonth = calculateCurrentMonthPartnerCut();
            const totalExpensesThisMonth = totalRealExpensesThisMonth + totalPartnerCutThisMonth;
            const totalPendingValueThisMonth = calculateCurrentMonthPendingValue();
            
            // TABLA HISTÓRICA
            const historyHtml = historyData.map(h => `
                <tr class="border-b hover:bg-gray-50 text-sm">
                    <td class="py-3 px-4 font-medium text-gray-700 capitalize">${h.label}</td>
                    <td class="py-3 px-4 text-green-600 font-semibold">${safeDisplayValue(h.income, 'income')}</td>
                    <td class="py-3 px-4 text-red-600">${safeDisplayValue(h.expense, 'expense')}</td>
                    <td class="py-3 px-4 text-gray-600">${safeDisplayValue(h.partner, 'partner')}</td>
                    <td class="py-3 px-4 text-center text-yellow-600 font-bold">${h.pendingCount > 0 ? h.pendingCount : '-'}</td>
                </tr>
            `).join('');
            
            const expensesHistoryHtml = currentMonthRealExpenses.length > 0 ? currentMonthRealExpenses.map(exp => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-4 text-sm text-gray-700">${new Date(exp.date).toLocaleString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })} hs</td>
                    <td class="py-3 px-4 text-sm text-gray-700">
                        <span class="font-medium text-gray-900">${exp.concept}</span>
                        ${exp.payee ? `<br><span class="text-xs text-gray-500 bg-gray-100 px-1 rounded">Pagado a: ${exp.payee}</span>` : ''}
                    </td>
                    <td class="py-3 px-4 text-sm font-bold text-red-600">${safeDisplayValue(exp.amount, 'expense')}</td>
                    <td class="py-3 px-4 text-sm text-right">
                        <button onclick="openEditExpenseModal('${exp.id}')" class="p-1 text-blue-600 hover:text-blue-800">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <button onclick="openDeleteExpenseModal('${exp.id}')" class="p-1 text-red-600 hover:text-red-800">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </td>
                </tr>
            `).join('') : `<tr><td colspan="4" class="py-6 px-4 text-center text-gray-500">No hay egresos registrados este mes.</td></tr>`;

            const filteredPayeeTotals = Object.entries(payeeTotals).filter(([name]) => name.toLowerCase() !== 'enzo');
            const payeeTotalsHtml = filteredPayeeTotals.length > 0 
                ? `<div class="mt-4 grid grid-cols-2 md:grid-cols-5 gap-4 border-t pt-4">
                    ${filteredPayeeTotals.map(([name, total]) => `
                        <div class="text-center sm:text-left">
                            <p class="text-xs text-gray-500">Total a ${name}</p>
                            <p class="text-lg font-bold text-gray-800">${safeDisplayValue(total, 'payee-total')}</p>
                        </div>
                    `).join('')}
                   </div>` 
                : '';

            container.innerHTML = `
                <div class="space-y-6">
                    <div class="card p-6 flex flex-col md:flex-row justify-between items-center flex-wrap gap-4">
                        <h2 class="text-2xl font-bold text-[var(--primary-color)] w-full md:w-auto text-center md:text-left">Valores Base</h2>
                        <div class="grid grid-cols-2 gap-4 w-full md:w-auto md:flex md:space-x-8">
                            <div class="text-center">
                                <p class="text-xs font-semibold text-gray-500">UMA</p>
                                <p class="text-xl font-bold text-[var(--secondary-color)]">${safeDisplayValue(umaJusValues.UMA, 'base')}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs font-semibold text-gray-500">JUS</p>
                                <p class="text-xl font-bold text-[var(--secondary-color)]">${safeDisplayValue(umaJusValues.JUS, 'base')}</p>
                            </div>
                        </div>
                        <button onclick="openUmaJusModal()" class="secondary-btn px-4 py-2 w-full md:w-auto text-sm">Editar Valores</button>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card p-5 text-center transition-transform transform hover:scale-[1.02] border-green-400 border-l-4">
                            <p class="text-sm font-semibold text-gray-500">Ingresos Netos</p>
                            <p class="text-4xl font-extrabold text-green-600">${safeDisplayValue(totalIncomeThisMonth, 'income')}</p>
                        </div>
                         <div class="card p-5 text-center transition-transform transform hover:scale-[1.02] border-red-400 border-l-4">
                            <p class="text-sm font-semibold text-gray-500">Egresos Totales</p>
                            <p class="text-4xl font-extrabold text-red-600">${safeDisplayValue(totalExpensesThisMonth, 'expense')}</p>
                        </div>
                        <div class="card p-5 text-center transition-transform transform hover:scale-[1.02] border-blue-400 border-l-4">
                            <p class="text-sm font-semibold text-gray-500">Clientes al Día</p>
                            <div class="flex justify-center items-end gap-2">
                                <p class="text-4xl font-extrabold text-blue-600">${clientsPaidThisMonth}</p>
                                <p class="text-lg font-medium text-blue-400 mb-1">(${clientsPaidPercent}%)</p>
                            </div>
                        </div>
                        <div class="card p-5 text-center transition-transform transform hover:scale-[1.02] border-orange-400 border-l-4">
                            <p class="text-sm font-semibold text-gray-500">Clientes Deudores</p>
                            <p class="text-4xl font-extrabold text-orange-600">${clientsPendingThisMonth}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div class="card p-5 text-center transition-transform transform hover:scale-[1.02] border-red-400 border-l-4">
                            <p class="text-sm font-semibold text-gray-500">Monto Socios</p>
                            <p class="text-4xl font-extrabold text-red-600">${safeDisplayValue(totalPartnerCutThisMonth, 'partner')}</p>
                        </div>
                        <div class="card p-5 text-center transition-transform transform hover:scale-[1.02] border-yellow-400 border-l-4">
                            <p class="text-sm font-semibold text-gray-500">Pendiente Neto</p>
                            <p class="text-4xl font-extrabold text-yellow-600">${safeDisplayValue(totalPendingValueThisMonth, 'pending')}</p>
                        </div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-xl font-semibold text-[var(--primary-color)] mb-4 border-b pb-2">Proyección de Ingresos Netos</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        ${projectionData.map(p => `<th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${p.month.charAt(0).toUpperCase() + p.month.slice(1)}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        ${projectionData.map(p => `<td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${safeDisplayValue(p.amount, 'income')}</td>`).join('')}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 border-b pb-2 gap-4">
                            <h3 class="text-xl font-semibold text-[var(--primary-color)]">Historial de Egresos</h3>
                            <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                                <button onclick="openEditExpenseConceptsModal()" class="secondary-btn px-4 py-2 text-sm w-full sm:w-auto">Editar Conceptos</button>
                                <button onclick="openAddExpenseModal()" class="action-btn px-4 py-2 text-sm w-full sm:w-auto">+ Registrar Egreso</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha y Hora</th>
                                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Concepto / Beneficiario</th>
                                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">${expensesHistoryHtml}</tbody>
                            </table>
                        </div>
                        ${payeeTotalsHtml}
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold text-[var(--primary-color)] mb-4 border-b pb-2">Historial de Meses Anteriores</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mes</th>
                                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ingresos (Neto)</th>
                                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Egresos (Total)</th>
                                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto Socios</th>
                                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cuotas Pendientes</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${historyHtml.length > 0 ? historyHtml : '<tr><td colspan="5" class="text-center py-4 text-gray-500">No hay datos históricos suficientes.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderClientsList = (searchTerm = '') => {
            const container = document.getElementById('clients');
            if (!container) return;
            
            const finalSearchTerm = searchTerm || document.getElementById('client-search-input')?.value || '';
            const filteredClients = clients.filter(c =>
                !finalSearchTerm ||
                (c.fullName && c.fullName.toLowerCase().includes(finalSearchTerm.toLowerCase())) ||
                (c.dni && c.dni.includes(finalSearchTerm)) ||
                (c.expedientes || []).some(e => e.toLowerCase().includes(finalSearchTerm.toLowerCase()))
            );

            const clientRows = filteredClients.map(client => {
                const { paidCount, progressPercent } = calculatePaymentInfo(client);
                const totalQuotas = client.paymentPlan ? client.paymentPlan.totalQuotas : 0;
                
                const monthStatus = getCurrentMonthQuotaStatus(client.paymentPlan ? { ...client.paymentPlan, quotas: client.quotas } : {});
                let statusColor = 'bg-gray-100 text-gray-700'; 

                if (totalQuotas > 0) {
                    if (monthStatus === 'paid') {
                        statusColor = 'bg-green-100 text-green-700'; 
                    } else if (monthStatus === 'pending') {
                        statusColor = 'bg-red-100 text-red-700'; 
                    }
                }
                
                const quotaText = totalQuotas > 0 ? `${paidCount} / ${totalQuotas} Cuotas` : "Sin Plan";

                return `
                    <li onclick="openClientDetail('${client.id}', 'clients')" class="card p-4 flex flex-col sm:flex-row items-start sm:items-center justify-between cursor-pointer hover:bg-gray-50 transition-all duration-300 transform hover:scale-[1.01] mb-2 gap-3">
                        <div class="flex-1 min-w-0 w-full">
                            <div class="flex flex-col items-start sm:flex-row sm:items-center gap-2">
                                <p class="text-lg font-semibold text-[var(--primary-color)]">${client.fullName}</p>
                                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded whitespace-nowrap">DNI: ${client.dni || 'N/A'}</span>
                            </div>
                            <p class="text-sm text-gray-500 break-words whitespace-normal mt-1">Exp: ${(client.expedientes || []).join(', ') || 'N/A'}</p>
                            <div class="mt-1 text-xs text-gray-500 flex flex-wrap gap-2">
                                ${client.phone ? `<span class="flex items-center gap-1">📞 ${client.phone}</span>` : ''}
                                ${client.email ? `<span class="flex items-center gap-1">✉️ ${client.email}</span>` : ''}
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-3 w-full sm:w-auto justify-between sm:justify-end">
                            <div class="text-right mr-2">
                                <span class="text-sm font-bold block ${statusColor} px-3 py-1 rounded-full shadow-inner">
                                    ${quotaText}
                                </span>
                            </div>
                            
                            <div class="flex gap-2">
                                <button onclick="event.stopPropagation(); openAddEditClientPanel('${client.id}')" class="p-2 text-blue-600 hover:bg-blue-100 rounded-full transition-colors" title="Editar Cliente">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                                <button onclick="event.stopPropagation(); openDeleteClientModal('${client.id}')" class="p-2 text-red-600 hover:bg-red-100 rounded-full transition-colors" title="Eliminar Cliente">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </li>
                `;
            }).join('');

            container.innerHTML = `
                <div class="max-w-4xl mx-auto space-y-4">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-[var(--primary-color)] mb-3 sm:mb-0">Gestión de Clientes</h2>
                        <button onclick="openAddEditClientPanel()" class="action-btn px-4 py-2 text-sm w-full sm:w-auto">+ Agregar Cliente</button>
                    </div>

                    <div class="mb-4">
                        <input type="text" id="client-search-input" value="${finalSearchTerm}" oninput="searchClients(this.value)" placeholder="Buscar por Nombre, DNI o Expediente..."
                            class="w-full p-3 border border-gray-300 rounded-lg shadow-sm transition-shadow">
                    </div>

                    <ul id="client-list" class="space-y-3">
                        ${clientRows.length > 0 ? clientRows : '<p class="text-center text-gray-500 p-8 card">No se encontraron clientes.</p>'}
                    </ul>
                </div>
            `;
            
            const input = document.getElementById('client-search-input');
            if(input && finalSearchTerm) {
                input.focus();
                const val = input.value;
                input.value = '';
                input.value = val;
            }
        };

        window.searchClients = (searchTerm) => {
            renderClientsList(searchTerm);
        };
        
        const renderPaymentsList = (searchTerm = '') => {
            const container = document.getElementById('payments');
            if (!container) return;
            
            const filteredClients = clients.filter(c =>
                !searchTerm ||
                (c.fullName && c.fullName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (c.dni && c.dni.includes(searchTerm)) ||
                (c.expedientes || []).some(e => e.toLowerCase().includes(searchTerm.toLowerCase()))
            );
            const clientRows = filteredClients.map(client => {
                const monthStatus = getCurrentMonthQuotaStatus(client.paymentPlan ? { ...client.paymentPlan, quotas: client.quotas } : {});
                let statusColor, quotaText;

                switch (monthStatus) {
                    case 'paid': statusColor = 'bg-green-100 text-green-700'; quotaText = 'Pagado este mes'; break;
                    case 'pending': statusColor = 'bg-red-100 text-red-700'; quotaText = 'Pendiente este mes'; break;
                    default: statusColor = 'bg-gray-100 text-gray-700'; quotaText = 'Sin cuota este mes';
                }

                return `
                    <li onclick="openClientDetail('${client.id}', 'payments')" class="card p-4 flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-all duration-300 transform hover:scale-[1.01] mb-2">
                        <div class="flex-1 min-w-0">
                            <p class="text-lg font-semibold text-[var(--primary-color)]">${client.fullName}</p>
                            <p class="text-sm text-gray-500 truncate">Exp: ${(client.expedientes || []).join(', ') || 'N/A'}</p>
                        </div>
                        <div class="text-right ml-4">
                            <span class="text-sm font-bold block ${statusColor} px-3 py-1 rounded-full shadow-inner">
                                ${quotaText}
                            </span>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </li>
                `;
            }).join('');
            
            const filteredOtherIncomes = otherIncomePlans.filter(p =>
                !searchTerm ||
                p.concept.toLowerCase().includes(searchTerm.toLowerCase())
            );
            const otherIncomeRows = filteredOtherIncomes.map(plan => {
                const monthStatus = getCurrentMonthQuotaStatus(plan.paymentPlan ? { ...plan.paymentPlan, quotas: plan.quotas } : {});
                let statusColor, quotaText;
                switch (monthStatus) {
                    case 'paid': statusColor = 'bg-green-100 text-green-700'; quotaText = 'Pagado este mes'; break;
                    case 'pending': statusColor = 'bg-red-100 text-red-700'; quotaText = 'Pendiente este mes'; break;
                    default: statusColor = 'bg-gray-100 text-gray-700'; quotaText = 'Sin cuota este mes';
                }
                return `
                    <li onclick="openOtherIncomeDetail('${plan.id}')" class="card p-4 flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-all duration-300 transform hover:scale-[1.01] mb-2">
                        <div class="flex-1 min-w-0">
                            <p class="text-lg font-semibold text-[var(--primary-color)]">${plan.concept}</p>
                            <p class="text-sm text-gray-500 truncate">Otro Ingreso</p>
                        </div>
                        <div class="text-right ml-4">
                            <span class="text-sm font-bold block ${statusColor} px-3 py-1 rounded-full shadow-inner">
                                ${quotaText}
                            </span>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </li>
                `;
            }).join('');
            
            container.innerHTML = `
                <div class="max-w-4xl mx-auto space-y-4">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-[var(--primary-color)] mb-3 sm:mb-0">Gestión de Pagos</h2>
                        <button onclick="openAddOtherIncomeModal()" class="action-btn px-4 py-2 text-sm w-full sm:w-auto">+ Otros Ingresos</button>
                    </div>
                    <div class="mb-4">
                        <input type="text" id="payments-search-input" oninput="searchPayments(this.value)" placeholder="Buscar cliente u otro ingreso..."
                            class="w-full p-3 border border-gray-300 rounded-lg shadow-sm transition-shadow">
                    </div>
                    <h3 class="text-2xl font-semibold text-[var(--primary-color)] pt-4">Pagos de Clientes</h3>
                    <ul id="payment-client-list" class="space-y-3">${clientRows.length > 0 ? clientRows : '<p class="text-center text-gray-500 p-8 card">No se encontraron clientes.</p>'}</ul>
                    <h3 class="text-2xl font-semibold text-[var(--primary-color)] pt-4">Otros Ingresos</h3>
                    <ul id="other-income-list" class="space-y-3">${otherIncomeRows.length > 0 ? otherIncomeRows : '<p class="text-center text-gray-500 p-8 card">No se encontraron otros ingresos.</p>'}</ul>
                </div>
            `;
        };
        
        window.searchPayments = (searchTerm) => {
            renderPaymentsList(searchTerm);
        };

        const renderTasks = () => {
            const container = document.getElementById('tasks');
            if (!container) return;

            const pendingTasks = tasks.filter(t => !t.completed);
            const completedTasks = tasks.filter(t => t.completed).sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));
            
            // Filtros por persona
            const tasksEnzo = pendingTasks.filter(t => t.assignee === 'Enzo');
            const tasksNora = pendingTasks.filter(t => t.assignee === 'Nora');
            const tasksCamila = pendingTasks.filter(t => t.assignee === 'Camila');
            const tasksTeo = pendingTasks.filter(t => t.assignee === 'Teo');

            const renderTaskList = (taskList, isCompleted = false) => {
                if (taskList.length === 0) return '<p class="text-gray-400 italic text-xs text-center py-2">Sin tareas pendientes.</p>';
                return taskList.map(t => {
                    let dateDisplay = '';
                    let dateColorClass = 'text-gray-400';
                    if (t.dueDate && !isCompleted) {
                        const due = new Date(t.dueDate);
                        const today = new Date();
                        today.setHours(0,0,0,0);
                        const dueStr = due.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit' });
                        dateDisplay = `📅 ${dueStr}`;
                        
                        if (due < today) dateColorClass = 'text-red-500 font-bold';
                        else if (due.getTime() === today.getTime()) dateColorClass = 'text-orange-500 font-bold';
                        else dateColorClass = 'text-blue-500';
                    }

                    let borderClass = 'border-gray-300';
                    if (t.assignee === 'Nora') borderClass = 'border-[var(--nora-color)]';
                    if (t.assignee === 'Enzo') borderClass = 'border-[var(--enzo-color)]';
                    if (t.assignee === 'Camila') borderClass = 'border-purple-400';
                    if (t.assignee === 'Teo') borderClass = 'border-teal-400';

                    return `
                    <div class="bg-white p-3 mb-2 rounded shadow-sm border-l-4 ${borderClass} flex justify-between items-start group hover:shadow-md transition-all">
                        <div class="flex-1 min-w-0 pr-2">
                            <p class="text-gray-800 text-sm font-medium break-words leading-tight ${isCompleted ? 'line-through text-gray-400' : ''}">${t.description}</p>
                            <div class="flex flex-wrap items-center gap-2 mt-1.5">
                                <span class="text-[10px] uppercase font-bold text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded">${t.assignee}</span>
                                ${t.relatedTo ? `<span class="text-[10px] text-gray-600 bg-blue-50 px-1.5 py-0.5 rounded truncate max-w-[100px]" title="${t.relatedTo}">Ref: ${t.relatedTo}</span>` : ''}
                                ${dateDisplay ? `<span class="text-[10px] ${dateColorClass} bg-white border border-gray-100 px-1.5 py-0.5 rounded shadow-sm">${dateDisplay}</span>` : ''}
                            </div>
                            ${isCompleted ? `<p class="text-[10px] text-gray-400 mt-1">Listo: ${new Date(t.completedAt).toLocaleString()}</p>` : ''}
                        </div>
                        <button onclick="toggleTaskStatus('${t.id}', ${!t.completed})" class="flex-shrink-0 p-1.5 rounded-full ${isCompleted ? 'bg-gray-100 text-gray-400' : 'bg-green-50 text-green-600 hover:bg-green-500 hover:text-white'} transition-colors">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                `}).join('');
            };
            
            const clientOptions = clients.map(c => `<option value="${c.fullName}">${c.fullName}</option>`).join('');

            container.innerHTML = `
                <div class="max-w-7xl mx-auto space-y-6">
                    <h2 class="text-3xl font-bold text-[var(--primary-color)]">Gestión de Tareas</h2>
                    
                    <div class="card p-4 bg-gradient-to-r from-blue-50 to-white border border-blue-100">
                        <div class="flex flex-col xl:flex-row gap-3 items-end">
                            <div class="w-full xl:flex-1">
                                <label class="text-xs font-bold text-gray-500 ml-1">Descripción</label>
                                <input type="text" id="task-desc-input" placeholder="¿Qué hay que hacer?" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-200" oninput="handleTaskInput(event)">
                            </div>
                            
                            <div class="w-full xl:w-auto flex gap-2">
                                <div class="w-1/2 xl:w-32">
                                    <label class="text-xs font-bold text-gray-500 ml-1">Asignar a</label>
                                    <select id="task-assignee-select" class="w-full p-2 border rounded-lg bg-white">
                                        <option value="Enzo">Enzo</option>
                                        <option value="Nora">Nora</option>
                                        <option value="Camila">Camila</option>
                                        <option value="Teo">Teo</option>
                                    </select>
                                </div>
                                <div class="w-1/2 xl:w-36">
                                    <label class="text-xs font-bold text-gray-500 ml-1">Para cuando</label>
                                    <input type="date" id="task-duedate-input" class="w-full p-2 border rounded-lg bg-white text-sm">
                                </div>
                            </div>

                            <div class="w-full xl:w-48 relative">
                                <label class="text-xs font-bold text-gray-500 ml-1">Referencia</label>
                                <select id="task-related-select" onchange="handleTaskRelatedChange(this)" class="w-full p-2 border rounded-lg bg-white">
                                    <option value="">General / Ninguno</option>
                                    ${clientOptions}
                                    <option value="__manual__" class="font-bold text-blue-600">✍️ Otro / Manual...</option>
                                </select>
                                <div id="task-related-input-wrapper" class="hidden flex items-center gap-1 w-full absolute bottom-0 left-0 z-10">
                                    <input type="text" id="task-related-input" placeholder="Ref..." class="flex-1 p-2 border rounded-lg shadow-sm">
                                    <button onclick="resetTaskRelatedSelect()" class="p-2 bg-white border rounded-lg hover:bg-gray-100">✕</button>
                                </div>
                            </div>
                            
                            <button onclick="addTask()" class="action-btn px-6 py-2 h-[42px] w-full xl:w-auto shadow-md">AGREGAR</button>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="bg-gray-50 rounded-xl p-3 border border-gray-200">
                            <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-[var(--enzo-color)]"></span> Enzo
                            </h3>
                            <div class="space-y-2 min-h-[50px]">${renderTaskList(tasksEnzo)}</div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-xl p-3 border border-gray-200">
                            <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-[var(--nora-color)]"></span> Nora
                            </h3>
                            <div class="space-y-2 min-h-[50px]">${renderTaskList(tasksNora)}</div>
                        </div>

                        <div class="bg-gray-50 rounded-xl p-3 border border-gray-200">
                            <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-purple-400"></span> Camila
                            </h3>
                            <div class="space-y-2 min-h-[50px]">${renderTaskList(tasksCamila)}</div>
                        </div>

                        <div class="bg-gray-50 rounded-xl p-3 border border-gray-200">
                            <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-teal-400"></span> Teo
                            </h3>
                            <div class="space-y-2 min-h-[50px]">${renderTaskList(tasksTeo)}</div>
                        </div>
                    </div>

                    <div class="mt-8 border-t pt-4">
                         <details class="group">
                            <summary class="flex items-center cursor-pointer text-gray-500 font-medium list-none">
                                <span class="transition group-open:rotate-90 mr-2">▶</span> Historial de Completadas (${completedTasks.length})
                            </summary>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mt-4">
                                ${renderTaskList(completedTasks, true)}
                            </div>
                        </details>
                    </div>
                </div>
            `;
        };

        window.handleTaskRelatedChange = (select) => {
            if (select.value === '__manual__') {
                select.classList.add('invisible'); 
                const wrapper = document.getElementById('task-related-input-wrapper');
                wrapper.classList.remove('hidden');
                wrapper.classList.add('flex');
                setTimeout(() => document.getElementById('task-related-input').focus(), 100);
                document.getElementById('task-related-input').value = '';
            }
        };

        window.resetTaskRelatedSelect = () => {
            const select = document.getElementById('task-related-select');
            select.value = ""; 
            select.classList.remove('invisible');
            
            const wrapper = document.getElementById('task-related-input-wrapper');
            wrapper.classList.add('hidden');
            wrapper.classList.remove('flex');
        };

        window.handleTaskInput = (event) => {
            const input = event.target;
            const cursorStart = input.selectionStart;
            const val = input.value;
            const newVal = val.replace(/\b([a-záéíóúñ]{4,})\b/gi, function(match) { return match.toUpperCase(); });
            if (newVal !== val) {
                input.value = newVal;
                input.setSelectionRange(cursorStart, cursorStart);
            }
        };

        window.addTask = async () => {
            const descInput = document.getElementById('task-desc-input');
            const assigneeSelect = document.getElementById('task-assignee-select');
            const dateInput = document.getElementById('task-duedate-input'); // NUEVO INPUT
            
            let relatedTo = '';
            const select = document.getElementById('task-related-select');
            const inputWrapper = document.getElementById('task-related-input-wrapper');
            const manualInput = document.getElementById('task-related-input');

            if (inputWrapper && !inputWrapper.classList.contains('hidden')) {
                relatedTo = manualInput.value.trim();
            } else if (select) {
                relatedTo = select.value === '__manual__' ? '' : select.value;
            }
            
            const description = descInput.value.trim();
            if (!description) return;
            
            try {
                await addDoc(collection(db, TASKS_COLLECTION_PATH), {
                    description,
                    assignee: assigneeSelect.value,
                    relatedTo: relatedTo,
                    dueDate: dateInput.value || null, // GUARDAR FECHA
                    completed: false,
                    createdAt: new Date().toISOString()
                });
                descInput.value = '';
                dateInput.value = ''; // LIMPIAR FECHA
                resetTaskRelatedSelect();
                
                showToast('Tarea agregada', 'success');
            } catch (e) { showToast('Error al crear tarea', 'error'); }
        };

        window.toggleTaskStatus = async (taskId, newStatus) => {
            try {
                const updateData = { completed: newStatus };
                if (newStatus) updateData.completedAt = new Date().toISOString();
                await updateDoc(doc(db, TASKS_COLLECTION_PATH, taskId), updateData);
            } catch (e) { showToast('Error al actualizar tarea', 'error'); }
        };

        window.openClientDetail = (clientId, originView) => {
            currentClientDetailId = clientId;
            currentOtherIncomeDetailId = null;
            openFullPanel('client-detail-panel');
            renderClientDetail(clientId, originView);
        };

        window.openOtherIncomeDetail = (planId) => {
            currentClientDetailId = null;
            currentOtherIncomeDetailId = planId;
            openFullPanel('other-income-detail-panel');
            renderOtherIncomeDetail(planId);
        };


        const renderClientDetail = (clientId, originView = null) => {
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                closeFullPanel('client-detail-panel');
                return;
            }

            const { quotaValueArs, paidCount, progressPercent, quotaValueUnits, partnerCutPercent } = calculatePaymentInfo(client);
            const { totalUnits = 0, totalQuotas = 0, unit = 'N/A', fixedAmount = 0, partnerName } = client.paymentPlan || {};

            if (document.getElementById('client-detail-name')) document.getElementById('client-detail-name').textContent = client.fullName;
            if (document.getElementById('client-detail-expedientes')) document.getElementById('client-detail-expedientes').textContent = (client.expedientes || []).join(', ');
            if (document.getElementById('client-notes')) document.getElementById('client-notes').value = client.notes || '';

            if (document.getElementById('plan-units')) document.getElementById('plan-units').textContent = safeDisplayValue(totalUnits.toString().replace('.', ','), 'raw'); // Use raw because it might not be currency
            if (document.getElementById('plan-unit-type')) document.getElementById('plan-unit-type').textContent = unit;
            
            const fixedDisplay = document.getElementById('plan-extra-fixed-display');
            if (fixedDisplay) {
                if (fixedAmount > 0) {
                    fixedDisplay.classList.remove('hidden');
                    if (document.getElementById('plan-extra-fixed-amount')) document.getElementById('plan-extra-fixed-amount').textContent = safeDisplayValue(fixedAmount, 'raw');
                } else {
                    fixedDisplay.classList.add('hidden');
                }
            }

            if (document.getElementById('plan-total-quotas')) document.getElementById('plan-total-quotas').textContent = totalQuotas;
            if (document.getElementById('plan-partner-cut')) document.getElementById('plan-partner-cut').textContent = partnerCutPercent || 0;
            
            if (document.getElementById('plan-partner-name')) {
                document.getElementById('plan-partner-name').textContent = partnerName ? `(${partnerName})` : '';
            }
            
            // PROTEGIDO VISIBLE
            if (document.getElementById('plan-quota-value-ars')) document.getElementById('plan-quota-value-ars').textContent = safeDisplayValue(quotaValueArs, 'quota');
            const progressIndicator = document.getElementById('progress-indicator');
            const progressRing = document.getElementById('progress-ring-container');
            const circleColor = (totalQuotas > 0 && progressPercent === 100) ? 'stroke-green-500' : (totalQuotas > 0) ? 'stroke-red-500' : 'stroke-gray-400';
            const circumference = 2 * Math.PI * 40; 
            const offset = totalQuotas > 0 ? circumference - (progressPercent / 100) * circumference : circumference;
            if(progressIndicator) progressIndicator.textContent = `${progressPercent}%`;
            if(progressRing) progressRing.innerHTML = `<svg class="w-24 h-24 transform -rotate-90"><circle cx="48" cy="48" r="40" stroke="#E5E7EB" stroke-width="8" fill="none"></circle><circle cx="48" cy="48" r="40" stroke-width="8" class="${circleColor} transition-all duration-700 ease-out" fill="none" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"></circle></svg><div class="absolute text-2xl font-bold text-[var(--primary-color)]">${progressPercent}%</div>`;

            const quotasListContainer = document.getElementById('quotas-list');
            if(quotasListContainer) {
                if (!client.quotas || client.quotas.length === 0) {
                    quotasListContainer.innerHTML = '<p class="text-center text-gray-500 p-4">No hay cuotas definidas para este cliente.</p>';
                } else {
                    quotasListContainer.innerHTML = client.quotas.map(quota => {
                        const isPaid = quota.isPaid;
                        const statusBg = isPaid ? 'bg-green-100 hover:bg-green-200' : 'bg-red-100 hover:bg-red-200';
                        const statusText = isPaid ? 'Pagada' : 'Pendiente';
                        const paidDate = isPaid && quota.paidDate ? new Date(quota.paidDate).toLocaleDateString('es-AR', { timeZone: 'UTC' }) : 'N/A';
                        
                        // Lógica de protección de montos
                        let valueDisplay = `${quotaValueUnits.toFixed(2).replace('.', ',')} ${unit} ${fixedAmount > 0 ? '+ Extra' : ''} (${formatCurrency(quotaValueArs)})`;

                        const startDate = client.paymentPlan.startMonth ? new Date(client.paymentPlan.startMonth + '-02T12:00:00Z') : null;
                        let monthYear = '';
                        if (startDate) {
                            const quotaDate = new Date(startDate);
                            quotaDate.setUTCMonth(startDate.getUTCMonth() + (quota.index - 1));
                            monthYear = quotaDate.toLocaleString('es-AR', { timeZone: 'UTC', month: 'long', year: 'numeric' });
                            monthYear = ' - ' + monthYear.charAt(0).toUpperCase() + monthYear.slice(1);
                        }

                        return `
                            <div class="flex items-center justify-between p-3 rounded-lg shadow-sm transition-all duration-200 ${statusBg} border border-gray-200">
                                <div class="flex items-center space-x-4">
                                    <span class="text-xl font-extrabold w-8 text-center text-[var(--primary-color)]">${quota.index}</span>
                                    <div>
                                        <p class="text-sm font-semibold">Cuota #${quota.index}<span class="text-xs font-normal text-gray-500">${monthYear}</span></p>
                                        <p class="text-xs text-gray-600">${valueDisplay}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <p class="text-xs text-gray-500 hidden sm:block">Pagada el: ${paidDate}</p>
                                    <button onclick="toggleQuotaPaid('${clientId}', ${quota.index})" class="px-3 py-1 text-sm rounded-full font-medium transition-colors duration-200 ${isPaid ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-red-600 text-white hover:bg-red-700'}">
                                        ${statusText}
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
        };
        
        const renderOtherIncomeDetail = (planId) => {
            const plan = otherIncomePlans.find(p => p.id === planId);
            if (!plan) {
                closeFullPanel('other-income-detail-panel');
                return;
            }

            const { quotaValueArs, paidCount, progressPercent, quotaValueUnits, partnerCutPercent } = calculatePlanInfo(plan.paymentPlan, plan.quotas);
            const { totalUnits, totalQuotas, unit, partnerName } = plan.paymentPlan;

            if (document.getElementById('other-income-detail-name')) document.getElementById('other-income-detail-name').textContent = plan.concept;
            const infoContainer = document.getElementById('other-income-extra-info');
            if (infoContainer) {
                infoContainer.innerHTML = `
                    <div><span class="font-bold">Tel:</span> ${plan.phone || '-'}</div>
                    <div><span class="font-bold">Email:</span> ${plan.email || '-'}</div>
                    <div><span class="font-bold">Exp:</span> ${plan.expediente || '-'}</div>
                `;
            }

            if (document.getElementById('other-income-plan-units')) document.getElementById('other-income-plan-units').textContent = safeDisplayValue(totalUnits.toString().replace('.', ','), 'raw'); 
            if (document.getElementById('other-income-plan-unit-type')) document.getElementById('other-income-plan-unit-type').textContent = unit;
            if (document.getElementById('other-income-plan-total-quotas')) document.getElementById('other-income-plan-total-quotas').textContent = totalQuotas;
            if (document.getElementById('other-income-partner-cut')) document.getElementById('other-income-partner-cut').textContent = partnerCutPercent || 0;
            if (document.getElementById('other-income-partner-name')) document.getElementById('other-income-partner-name').textContent = partnerName ? `(${partnerName})` : '';

            if (document.getElementById('other-income-plan-quota-value-ars')) document.getElementById('other-income-plan-quota-value-ars').textContent = safeDisplayValue(quotaValueArs, 'quota');

            const quotasListContainer = document.getElementById('other-income-quotas-list');
            if(quotasListContainer) {
                quotasListContainer.innerHTML = (plan.quotas || []).map(quota => {
                    const isPaid = quota.isPaid;
                    const statusBg = isPaid ? 'bg-green-100 hover:bg-green-200' : 'bg-red-100 hover:bg-red-200';
                    const statusText = isPaid ? 'Pagada' : 'Pendiente';
                    const paidDate = isPaid && quota.paidDate ? new Date(quota.paidDate).toLocaleDateString('es-AR', { timeZone: 'UTC' }) : 'N/A';
                    
                    let valueDisplay = `${quotaValueUnits.toFixed(2).replace('.', ',')} ${unit} (${formatCurrency(quotaValueArs)})`;
                    
                    const startDate = plan.paymentPlan.startMonth ? new Date(plan.paymentPlan.startMonth + '-02T12:00:00Z') : null;
                    let monthYear = '';
                    if (startDate) {
                        const quotaDate = new Date(startDate);
                        quotaDate.setUTCMonth(startDate.getUTCMonth() + (quota.index - 1));
                        monthYear = quotaDate.toLocaleString('es-AR', { timeZone: 'UTC', month: 'long', year: 'numeric' });
                        monthYear = ' - ' + monthYear.charAt(0).toUpperCase() + monthYear.slice(1);
                    }

                    return `
                        <div class="flex items-center justify-between p-3 rounded-lg shadow-sm transition-all duration-200 ${statusBg} border border-gray-200">
                            <div class="flex items-center space-x-4">
                                <span class="text-xl font-extrabold w-8 text-center text-[var(--primary-color)]">${quota.index}</span>
                                <div>
                                    <p class="text-sm font-semibold">Cuota #${quota.index}<span class="text-xs font-normal text-gray-500">${monthYear}</span></p>
                                    <p class="text-xs text-gray-600">${valueDisplay}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <p class="text-xs text-gray-500 hidden sm:block">Pagada el: ${paidDate}</p>
                                <button onclick="toggleOtherIncomeQuotaPaid('${planId}', ${quota.index})" class="px-3 py-1 text-sm rounded-full font-medium transition-colors duration-200 ${isPaid ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-red-600 text-white hover:bg-red-700'}">
                                    ${statusText}
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            setupFirebase();
        });

    </script>
</body>
</html>